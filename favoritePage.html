
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Infield Language Program Planning Tool</title>
<style>

/* ===== Passowrd Box styling ===== */
#password-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
}

#password-screen input,
#password-screen button {
  padding: 10px;
  font-size: 1rem;
  margin-top: 10px;
}

/* ===== Minor utility ===== */
.accordion-controls {
  display: flex;
  gap: 8px;
  margin: 4px 0 6px;
}

/* ===== THEME & BASE ===== */
:root{
  --text:#0f172a; --muted:#6b7280; --border:#cbd5e1; --bg:#ffffff;
  --gray-plan-bg:#f3f4f6;
  --green-border:#298e44; --green-bg:#dff3e6;
  --blue-border:#027da5;  --blue-bg:#e3f2fd;
  --yellow-border:#ffb81d;--yellow-bg:#fff4cf;
  --ok-bg:#22c55e; --ok-bg-hover:#16a34a; --ok-border:#15803d;
}
*{box-sizing:border-box}
body{
  margin:12px;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  line-height:1.5;font-size:17.5px;
}
h1{margin:0 0 6px 0;font-size:1.8rem}
h2{margin:18px 0 6px;font-size:1.22rem}
h3{margin:10px 0 4px;font-size:1.02rem}
hr{margin:18px 0;border:none;border-top:1px solid var(--border)}
/* Smaller H1 on small screens */
@media (max-width:480px){
  h1{font-size:1.42rem;}
}

/* ===== TOP ===== */
.top-row{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;flex-wrap:wrap}
.notice-line{font-size:.95rem}
.notice-info{
  display:inline-flex;align-items:center;gap:6px;
  font-size:.95rem;color:#222
}
.notice-info button{
  border:none;background:transparent;cursor:pointer;
  font-size:1rem;line-height:1;padding:0 2px;color:#0b6aa5
}
.notice-pop{
  position:fixed; /* fixed so we can use viewport coords */
  width: 700px; max-width:90vw; background:#fff; border:1px solid var(--border);
  border-radius:8px; padding:10px 12px; box-shadow:0 8px 24px rgba(0,0,0,.12);
  font-size:.95rem; z-index:20; display:none;
}
.notice-pop.show{display:block}

/* top controls */
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;margin-bottom:12px}
.controls label{font-weight:600;font-size:.9rem}
.controls select,.controls input[type="date"]{
  padding:6px 8px;font-size:.95rem;border-radius:6px;border:1px solid var(--border)
}

/* ===== PLAN ===== */
.plan-wrapper{
  border:2px solid #000;background:var(--gray-plan-bg);
  border-radius:10px;padding:10px;margin-bottom:14px
}
.plan-title{font-weight:800;font-size:1.05rem}
.plan-dates{color:var(--muted);margin-top:1px;margin-bottom:6px;font-size:.9rem}
.plan-grid{display:grid;grid-template-columns:1fr;gap:8px}
.plan-box{border-radius:9px;padding:8px}
.plan-box h4{margin:0 0 2px;font-size:.97rem}
.green-box{border:2px solid var(--green-border);background:var(--green-bg)}
.blue-box{ border:2px solid var(--blue-border); background:var(--blue-bg)}
.yellow-box{border:2px solid var(--yellow-border);background:var(--yellow-bg)}
.plan-list{list-style:none;padding-left:0;margin:0}

/* ===== CARDS (compact) ===== */
.card{
  background:#fff;border:1px solid var(--border);border-radius:10px;
  padding:10px 12px;margin:8px 0;box-shadow:0 1px 2px rgba(0,0,0,.05)
}
/* top row: remove (left) + circle-check + number/title + right actions (link + move) */
.card-row{display:flex;gap:6px}
.card-row.top{align-items:flex-start} /* top-align row so circle/number hug first line */
.card-title{display:flex;align-items:flex-start;gap:6px;flex:1;min-width:0}
.card-title .card-num{
  font-weight:400; /* un-bold number */
  font-size:.92rem;white-space:nowrap;line-height:1.1;
}
.card-title .card-title-text{
  font-weight:400;font-size:.9rem;line-height:1.25;white-space:normal;word-break:break-word
}
/* left actions: keep remove vertically centered within its own group */
.card-actions-left{display:flex;gap:6px;align-items:center}
.right-actions{display:flex;align-items:flex-start;gap:8px}

/* completion line */
.completion-line{color:var(--muted);font-size:.8rem;width:100%;margin-top:3px}

/* Buttons compact */
.add-btn,.remove-btn,.move-next,.btn{
  padding:8px 12px;border-radius:8px;border:1px solid var(--border);
  background:#fff;cursor:pointer;font-size:.95rem;line-height:1.1;
}
.add-btn{padding:2px 7px}
.remove-btn{padding:2px 7px}

/* Disabled state for Previous / Next week buttons */
.nav-btn:disabled{opacity:0.35;cursor:not-allowed}
.nav-btn:disabled .arrow,.nav-btn:disabled .label{opacity:0.35}

/* disable add when already in plan */
.add-btn:disabled{opacity:.5;background:#f2f2f2;cursor:not-allowed}

/* ext link only visible in plan; small & snug */
.ext-link{display:none;text-decoration:none;font-size:1.05rem;line-height:1}
.in-plan .ext-link{display:inline-flex}

/* icon-only move/repeat, no border */
.move-next{
  background:transparent;border:none;min-width:24px;height:24px;
  display:inline-flex;align-items:center;justify-content:center;color:#111;padding:0
}
.move-next:hover{color:#0b6aa5}
.move-next:disabled{opacity:.45;cursor:not-allowed}
.move-next{font-size:1.2rem}
.move-next.is-repeat{font-size:1.45rem}

/* Circle checkbox (unchecked = outline circle; checked = filled green w/ check) */
.circle-check{
  width:20px;height:20px;min-width:20px;min-height:20px;border-radius:50%;
  border:2px solid #9ca3af;background:#fff;display:inline-flex;align-items:center;justify-content:center;
  cursor:pointer;line-height:1;font-size:.9rem;color:#fff;
  align-self:flex-start; /* ensure it hugs the top */
}
.circle-check[aria-checked="true"]{
  background:var(--ok-bg); border-color:var(--ok-border);
}
.circle-check .mark{display:none}
.circle-check[aria-checked="true"] .mark{display:block}

/* completed style */
.completed .card-title-text{text-decoration:line-through;color:var(--muted)}

/* ===== PLAN ACTIONS ===== */
/* Plan actions laid out as Left | Center | Right */
.plan-actions{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap:6px;
  margin-top:6px;
}
/* Positioning ‚Äúzones‚Äù */
.actions-left{ justify-self:start; }
.actions-center{ justify-self:center; display:flex; gap:6px; flex-wrap:wrap; }
.actions-right{ justify-self:end; }
/* Prev/Next buttons: bold label + arrow */
.nav-btn{
  font-weight:800;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
/* Arrow styling */
.nav-btn .arrow{
  font-weight:800;
  line-height:1;
}
/* Small screens: show only the arrows on prev/next and icons in center */
@media (max-width: 520px){
  .nav-btn .label, .icon-btn .label{ display:none; }
}

/* ===== STICKY MINI ===== */
.sticky-mini{
  display:none;position:sticky;top:0;background:var(--gray-plan-bg);
  padding:6px 10px;border-bottom:2px solid #000;font-weight:700;cursor:pointer;z-index:10
}
.sticky-mini.show{display:block}

/* ===== ACCORDIONS ===== */
.section{margin-bottom:8px;border-bottom:1px dashed var(--border);padding-bottom:6px}
.section-header{cursor:pointer;font-size:.92rem;color:#334155;font-weight:600;display:flex;gap:6px;align-items:center}
.section-header .arrow{transition:transform .15s ease}
.section.collapsed .section-items{display:none}
.section.collapsed .section-header .arrow{transform:rotate(0deg)}
.section:not(.collapsed) .section-header .arrow{transform:rotate(90deg)}
.section-items{list-style:none;padding-left:0;margin-top:4px}
.source-list{list-style:none;margin:0;padding:0}
.source-list .card{padding:6px 8px;margin:5px 0}

/* ===== FOOTER ===== */
footer{text-align:center;font-size:.82rem}

/* ===== RESPONSIVE ===== */
@media (min-width:800px){ .plan-grid{grid-template-columns:1fr 1fr 1fr} }

/* ===== App Modal (custom alert/confirm) ===== */
.app-modal[aria-hidden="true"]{ display: none; }
.app-modal {
  position: fixed; inset: 0; z-index: 1000;
  display: grid; place-items: center;
}
.app-modal__backdrop {
  position: absolute; inset: 0; background: rgba(0,0,0,.35);
}
.app-modal__dialog {
  position: relative; width: min(700px, 90vw);
  background: #fff; border: 1px solid var(--border);
  border-radius: 10px; box-shadow: 0 12px 36px rgba(0,0,0,.22);
  overflow: hidden;
}
.app-modal__header {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; background: var(--gray-plan-bg); border-bottom:1px solid var(--border);
}
.app-modal__title { font-weight:800; }
.app-modal__close {
  border:none; background:transparent; font-size:1.2rem; cursor:pointer; line-height:1;
}
.app-modal__body { padding:14px 12px; font-size:.97rem; color:#111; white-space: pre-line;}
.app-modal__footer {
  display:flex; gap:8px; justify-content:flex-end; padding:10px 12px; border-top:1px solid var(--border);
}
@media (max-width: 520px){
  .app-modal__dialog { width: min(480px, 94vw); }
}

/* ===== Toast ===== */
.toast{
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  background: #111;
  color: #fff;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: .9rem;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s ease, transform .2s ease;
  z-index: 1200;
}
.toast.show{
  opacity: 0.95;
  transform: translateX(-50%) translateY(0);
}
@media (max-width: 520px){
  .toast{
    width: calc(100vw - 24px);
    text-align: center;
  }
}

/* Sticky footer bar */
.footer-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 30px;

  background-color: #003366; /* dark blue */
  color: white;

  display: flex;
  align-items: center;
  justify-content: center;

  z-index: 1000; /* Ensure it stays above content */
}

/* Prevent footer from covering content */
body {
  padding-bottom: 30px; /* matches footer height */
}

/* Hide the bottom Study Topic Options section (modal-only now) */
#sourcesSection { display: none; }

/* Add button layout inside plan boxes */
.plan-add { display: flex; justify-content: center; margin-top: 8px; }

/* Visuals for the add-open buttons */
.add-open {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: #fff;
  cursor: pointer;
  padding: 6px 10px;
  font-size: 1rem;
}

/* Icon-only when the box already has items */
.plan-box:not(.empty) .add-open .label { display: none; }
.plan-box:not(.empty) .add-open .icon { font-size: 1.2rem; }

/* Larger button with label when empty */
.plan-box.empty .add-open { padding: 10px 14px; font-weight: 700; }
.plan-box.empty .add-open .icon { font-size: 1.2rem; }

/* (Optional) tidy space above the add button when items exist */
.plan-box:not(.empty) .plan-add { margin-top: 6px; }

/* Make modals scroll within the dialog, max 90vh */
.app-modal__dialog {
  max-height: 90vh;
  display: flex;
  flex-direction: column;
}
.app-modal__body {
  overflow: auto;        /* allow scrolling in body */
  /* preserve your existing padding and font-size already set */
}

/* Ensure the picker sits beneath confirm dialogs */
.app-modal--picker { z-index: 900; }  /* default app-modal is 1000 in your file */


</style>
</head>
<body>

  <div class="top-row">
  <h1>Infield Language Program Planning Tool</h1>
  <!-- Option C: one-line microcopy + info button with a tiny popover -->
  <div class="notice-info" style="position:relative;">
    <span class="notice-line">Data stays on this device.</span>
    <button id="noticeBtn" aria-haspopup="dialog" aria-expanded="false" aria-controls="noticePop" title="More info">‚ìò</button>
    <div id="noticePop" class="notice-pop" role="dialog" aria-modal="false" aria-labelledby="noticeTitle">
      <strong id="noticeTitle">How your data is saved</strong>
      <p style="margin:.35rem 0 0;">
        Your data is saved only in your browser on this device. To avoid losing it,
        use the same browser and don‚Äôt clear your cache. Consider copying or writing down
        your language study plan each week as a backup.
      </p>
    </div>
  </div>
</div>

<!-- Password Box -->
<div id="password-screen">
  <h2>Please enter the password</h2>
  <input type="text" id="password-input" placeholder="Password" />
  <button id="password-submit">Enter</button>
  <p id="password-error" style="color:red; display:none;">Incorrect password</p>
</div>

<!-- Wrap ALL existing page content inside this container -->
<div id="protected-content" style="display:none;">
  <!-- Your existing content goes here -->




<div class="controls">
  <div>
    <label for="week-select">Week</label><br/>
    <select id="week-select"></select>
  </div>
  <div>
    <label for="entry-date">Infield Entry Date</label><br/>
    <input type="date" id="entry-date"/>
  </div>
</div>

<!-- Sticky shows week number -->
<div id="stickyMini" class="sticky-mini">‚Üí Week 1 Study Plan</div>

<div id="planWrapper" class="plan-wrapper">
  <div class="plan-title" id="planTitle"></div>
  <div class="plan-dates" id="planDates"></div>

  <div class="plan-grid">
    
    <div id="pmgBox" class="plan-box green-box">
      <h4>Preach My Gospel study section</h4>
      <ul id="planPMG" class="plan-list"></ul>

      <!-- Add button (PMG) -->
      <div class="plan-add">
        <button id="addPMG" class="add-open" data-kind="pmg">
          <span class="icon" aria-hidden="true">+</span>
          <span class="label">Add Chapter 7 topics</span>
        </button>
      </div>
    </div>
    
    <div id="skillBox" class="plan-box blue-box">
      <h4>Language Skills</h4>
      <ul id="planSkills" class="plan-list"></ul>

      <!-- Add button (Skills) -->
      <div class="plan-add">
        <button id="addSkill" class="add-open" data-kind="skill">
          <span class="icon" aria-hidden="true">+</span>
          <span class="label">Add language skills</span>
        </button>
      </div>
    </div>

    <div class="plan-box yellow-box">
      <h4>Evaluate Your Language Study</h4>
      <ul id="planEval" class="plan-list"></ul>
    </div>
  </div>

  <div class="plan-actions">
    <!-- Left: Previous Week -->
    <div class="actions-left">
      <button class="btn nav-btn prev" id="prevWeek" aria-label="Previous Week">
        <span class="arrow" aria-hidden="true">‚Üê</span>
        <span class="label">Previous Week</span>
      </button>
    </div>

    <!-- Center: Clear Week ‚Ä¢ Copy Plan ‚Ä¢ Clear All (new order) -->
    <div class="actions-center">
      <button class="btn icon-btn" id="clearWeek">
        <span class="icon" aria-hidden="true">üßπ</span>
        <span class="label">Clear Week</span>
      </button>
      <button class="btn icon-btn" id="copyPlan">
        <span class="icon" aria-hidden="true">‚ßâ</span>
        <span class="label">Copy Plan</span>
      </button>
      <button class="btn icon-btn" id="clearAll">
        <span class="icon" aria-hidden="true">üóë</span>
        <span class="label">Clear All</span>
      </button>
    </div>

    <!-- Right: Next Week -->
    <div class="actions-right">
      <button class="btn nav-btn next" id="nextWeek" aria-label="Next Week">
        <span class="label">Next Week</span>
        <span class="arrow" aria-hidden="true">‚Üí</span>
      </button>
    </div>
  </div>
</div>


  <!-- START: Source Section (hidden; used by modal only) -->
  <div id="sourcesSection">
    <hr />
    <h2>Study Topic Options</h2>

    <!-- PMG as an accordion under ‚ÄúPreach My Gospel Study‚Äù -->
    <h3>Preach My Gospel Study</h3>
    <div id="pmgSource"></div>

    <h3>Language Tasks and Skills</h3>
    <div class="accordion-controls">
      <button class="btn" id="expandAllLanguage">Expand all</button>
      <button class="btn" id="collapseAllLanguage">Collapse all</button>
    </div>
    <div id="languageSource"></div>
    <!-- END: Source Section -->
  </div>
</div> <!-- END: Protected Content -->



  <div class="footer-bar">
    <footer>
      The code and functionality of this page were created using AI.
  </footer>
  </div>



<script>

/* =========================================================
   Password Protection
   ========================================================= */

// Remember unlock across sessions (same device + browser)
(function () {
  const STORAGE_KEY = 'infield_unlock_v1';
  const CORRECT_PASSWORD = 'infield-26';

  // Cache elements
  const passwordScreen   = document.getElementById('password-screen');
  const protectedContent = document.getElementById('protected-content');
  const passwordError    = document.getElementById('password-error');
  const passwordInput    = document.getElementById('password-input');
  const submitBtn        = document.getElementById('password-submit');

  // Show/hide helpers
  function showLockedUI() {
    if (passwordScreen)   passwordScreen.style.display = 'flex';
    if (protectedContent) protectedContent.style.display = 'none';
  }
  function showUnlockedUI() {
    if (passwordScreen)   passwordScreen.style.display = 'none';
    if (protectedContent) protectedContent.style.display = 'block';
    if (passwordError)    passwordError.style.display = 'none';
    if (passwordInput)    passwordInput.value = '';
  }

  // Initial state (runs immediately; script is at end of body so elements exist)
  (function applyInitialLockState() {
    let unlocked = false;
    try { unlocked = localStorage.getItem(STORAGE_KEY) === 'true'; } catch (e) {}
    if (unlocked) showUnlockedUI(); else showLockedUI();
  })();

  // Unlock flow
  function unlock() {
    try { localStorage.setItem(STORAGE_KEY, 'true'); } catch (e) {}
    showUnlockedUI();
  }

  function tryUnlock() {
    const pw = (passwordInput?.value || '').trim();
    if (pw === CORRECT_PASSWORD) {
      unlock();
    } else {
      if (passwordError) passwordError.style.display = 'block';
      passwordInput?.focus();
      passwordInput?.select();
    }
  }

  // Wire events
  submitBtn?.addEventListener('click', tryUnlock);
  passwordInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') tryUnlock();
  });

  // Optional: expose a re-lock function (e.g., for a menu item)
  window.lockContent = function () {
    try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
    showLockedUI();
    setTimeout(() => passwordInput?.focus(), 50);
  };
})();


/* =========================================================
   CONTENT MAPS ‚Äî EDIT THESE ONLY
   (Kept intact from your original file)
   ========================================================= */
// PMG Topics (green box source)
const PMG_TOPICS = [
  { id: "pmg1", title: "Prepare Yourself Spiritually", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title3-p7#title3" },
  { id: "pmg2", title: "Be Dedicated and Diligent", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title4-p14#title4" },
  { id: "pmg3", title: "Principles of Language Learning", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title6-p21#title6" },
  { id: "pmg4", title: "Create a Language Study Plan", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title12-p35#title12" },
  { id: "pmg5", title: "Learn with Your Companions", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title14-figure4_p3#title14" },
  { id: "pmg6", title: "Culture and Language Learning", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title16-figure5_p2#title16" },
  { id: "pmg7", title: "The Gift of Tongues", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title18-figure6_p6#title18" },
  { id: "pmg8", title: "Ideas for Study and Application: Personal Study", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title19-aside2_p2#title19" },
  { id: "pmg9", title: "Ideas for Study and Application: Companion Study and Companion Exchange", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=aside2_title3-aside2_p7#aside2_title3" }
];

// Language sections (blue box source + accordions) ‚Äî full structure
const LANGUAGE_SECTIONS = [
  { id:"lesson1", title:"Lesson 1: The Message of the Restoration",
    items:[ { id:"item1", title:"Lesson 1: The Message of the Restoration", link:"#"} ] },
  { id:"lesson2", title:"Lesson 2: Heavenly Father‚Äôs Plan of Salvation",
    items:[ { id:"item2", title:"Lesson 2: Heavenly Father‚Äôs Plan of Salvation", link:"#"} ] },
  { id:"lesson3", title:"Lesson 3: The Gospel of Jesus Christ",
    items:[ { id:"item3", title:"Lesson 3: The Gospel of Jesus Christ", link:"#"} ] },
  { id:"pray-faith", title:"Pray with Faith in Jesus Christ",
    items:[
      { id:"item4", title:"‚ÄúPray for those you are teaching.‚Äù (105)", link:"#"},
      { id:"item5", title:"‚ÄúPray simply and sincerely that God will bless the people you are teaching‚Äù (181)", link:"#"},
      { id:"item6", title:"‚ÄúAs needed, teach the person how to pray‚Äù (72)", link:"#"}
  ]},
  { id:"talk-everyone", title:"Talk with Everyone",
    items:[
      { id:"item7", title:"‚ÄúAsk a question and listen to their response‚Äù (166)", link:"#"},
      { id:"item8", title:"‚ÄúAsk about their families. Help them see how the restored gospel can bless their families.‚Äù (166)", link:"#"},
      { id:"item9", title:"‚ÄúShare with them your purpose as a missionary and why you decided to serve a mission.‚Äù (166)", link:"#"}
  ]},
  { id:"unite-members", title:"Unite with Members",
    items:[
      { id:"item10", title:"‚ÄúBuild Strong Relationships with Local Leaders‚Äù (167)", link:"#"},
      { id:"item11", title:"‚ÄúSupport Members in Their Efforts to Share the Gospel‚Äù (168)", link:"#"},
      { id:"item12", title:"‚ÄúPromise Blessings for Sharing the Gospel‚Äù (169)", link:"#"}
  ]},
  { id:"find-people", title:"Find People Where They Are",
    items:[
      { id:"item13", title:"‚ÄúFind out what is most important to them‚Äù (171)", link:"#"},
      { id:"item14", title:"Seek to understand others‚Äô interests (171)", link:"#"},
      { id:"item15", title:"Discuss challenges people face (171)", link:"#"}
  ]},
  { id:"invite-spirit", title:"Invite the Spirit as You Begin Teaching",
    items:[
      { id:"item16", title:"‚ÄúAsk a few simple questions to help you understand their background and their expectations‚Äù (181)", link:"#"},
      { id:"item17", title:"‚ÄúExplain that you would like to begin and end each lesson with prayer.‚Äù (181)", link:"#"},
      { id:"item18", title:"‚ÄúGive a simple overview of what you will teach.‚Äù (182)", link:"#"}
  ]},
  { id:"use-scriptures", title:"Use the Scriptures",
    items:[
      { id:"item19", title:"‚ÄúIntroduce the Scripture‚Äù (183)", link:"#"},
      { id:"item20", title:"‚ÄúApply the Scriptures‚Äù (183)", link:"#"},
      { id:"item21", title:"‚ÄúInvite and Help People to Read on Their Own‚Äù (183)", link:"#"}
  ]},
  { id:"share-testimony-1", title:"Share Your Testimony (Part 1)",
    items:[
      { id:"item22", title:"‚ÄúShare a brief experience about how you gained this testimony.‚Äù (185)", link:"#"},
      { id:"item23", title:"‚ÄúWhen your companion is teaching, share your testimony to provide a second witness‚Äù (185)", link:"#"},
      { id:"item24", title:"‚ÄúShare your testimony that the principle you are teaching will bless the person‚Äôs life if he or she will follow it.‚Äù (185)", link:"#"}
  ]},
  { id:"teach-understanding", title:"Teach for Understanding",
    items:[
      { id:"item25", title:"‚ÄúAsk questions to help people think about what you have taught.‚Äù (189)", link:"#"},
      { id:"item26", title:"‚ÄúExplain words, phrases, and ideas.‚Äù (189)", link:"#"},
      { id:"item27", title:"‚ÄúKeep your teaching simple and brief.‚Äù (189)", link:"#"}
  ]},
  { id:"ask-questions", title:"Ask Questions",
    items:[
      { id:"item28", title:"‚ÄúAsk questions that help people feel the Spirit.‚Äù (190)", link:"#"},
      { id:"item29", title:"‚ÄúAsk questions that help you know how well people understand what you are teaching.‚Äù (190)", link:"#"},
      { id:"item30", title:"‚ÄúAsk questions that help people apply what they learn.‚Äù (191)", link:"#"}
  ]},
  { id:"extend-invitations", title:"Extend Invitations",
    items:[
      { id:"item31", title:"‚ÄúInvite with kind and clear language:‚Äù Church (203)", link:"#"},
      { id:"item32", title:"‚ÄúInvite with kind and clear language:‚Äù Baptism (203)", link:"#"},
      { id:"item33", title:"‚ÄúInvite with kind and clear language:‚Äù Read the scriptures (203)", link:"#"}
  ]},
  { id:"promise-blessings", title:"Promise People Blessings",
    items:[
      { id:"item34", title:"‚ÄúPrayerfully decide what blessings to promise each person as you extend invitations.‚Äù (204)", link:"#"},
      { id:"item35", title:"‚ÄúAssure [those you teach] that God will bless them as they strive to do His will.‚Äù (204)", link:"#"},
      { id:"item36", title:"‚ÄúHelp [those you teach] understand that opposition is an opportunity to grow by choosing to follow Christ even when it is difficult‚Äù (204)", link:"#"}
  ]},
  { id:"share-testimony-2", title:"Share Your Testimony (Part 2)",
    items:[
      { id:"item37", title:"‚ÄúShare your testimony whenever you extend an invitation and promise blessings.‚Äù (205)", link:"#"},
      { id:"item38", title:"‚ÄúTell how you have been blessed as you have lived the principle you are teaching.‚Äù (205)", link:"#"},
      { id:"item39", title:"‚ÄúShare your testimony that the principle will bless the person‚Äôs life as he or she lives it.‚Äù (205)", link:"#"}
  ]},
  { id:"keep-commitments", title:"Help People Keep Their Commitments",
    items:[
      { id:"item40", title:"‚ÄúEncourage and Help People in Your Daily Contact‚Äù (206)", link:"#"},
      { id:"item41", title:"‚ÄúHave the Influence of the Holy Ghost in Your Daily Contact‚Äù (206)", link:"#"},
      { id:"item42", title:"‚ÄúShow Love‚Äù (207)", link:"#"}
  ]},
  { id:"schedule-appointments", title:"Schedule Appointments",
    items:[ { id:"item43", title:"Schedule Appointments", link:"#"} ] },
  { id:"talk-food", title:"Talk about Food",
    items:[ { id:"item44", title:"Talk about Food", link:"#"} ] },
  { id:"talk-health", title:"Talk about Health",
    items:[ { id:"item45", title:"Talk about Health", link:"#"} ] },
  { id:"transportation", title:"Transportation",
    items:[ { id:"item46", title:"Transportation", link:"#"} ] },
  { id:"daily-life", title:"Daily Life Topic of Choice",
    items:[ { id:"item47", title:"Daily Life Topic of Choice", link:"#"} ] }
];

/* =========================================================
   STORAGE KEYS & HELPERS
   ========================================================= */
const WEEK_COUNT = 12;
const getFavKeyPMG   = (w)=> `plan_pmg_week_${w}`;
const getFavKeySkill = (w)=> `plan_skills_week_${w}`;
const getWeekStateKey= (w)=> `completion_week_${w}`;
const EVAL_KEY       = (w)=> `evaluation_week_${w}`;
const COUNTS_KEY     = "completionCounts";

const readSet  = (key)=> new Set(JSON.parse(localStorage.getItem(key) || "[]"));
const writeSet = (key, s)=> localStorage.setItem(key, JSON.stringify(Array.from(s)));
const readObj  = (key)=> JSON.parse(localStorage.getItem(key) || "{}");
const writeObj = (key, o)=> localStorage.setItem(key, JSON.stringify(o));
const readCounts = ()=> JSON.parse(localStorage.getItem(COUNTS_KEY) || "{}");
const writeCounts= (o)=> localStorage.setItem(COUNTS_KEY, JSON.stringify(o));
const getCount   = (id)=> (readCounts()[id] || 0);

function incCount(id){ const c=readCounts(); c[id]=(c[id]||0)+1; writeCounts(c); updateCompletionDisplays(id); }
function decCount(id){ const c=readCounts(); c[id]=Math.max(0,(c[id]||0)-1); writeCounts(c); updateCompletionDisplays(id); }

/* =========================================================
   DATE / WEEK LOGIC
   ========================================================= */
const weekSelect = document.getElementById("week-select");
let activeWeek = parseInt(localStorage.getItem("activeWeek") || "1",10);
if (isNaN(activeWeek) || activeWeek < 1 || activeWeek > WEEK_COUNT) activeWeek = 1;

for (let i=1;i<=WEEK_COUNT;i++){
  const opt = document.createElement("option");
  opt.value = String(i); opt.textContent = `Week ${i}`;
  weekSelect.appendChild(opt);
}
weekSelect.value = String(activeWeek);
weekSelect.addEventListener("change", ()=> setActiveWeek(parseInt(weekSelect.value,10)));

const entryDateEl = document.getElementById("entry-date");
(function initEntryDate(){
  const saved = localStorage.getItem("infieldEntryDate");
  const today = new Date();
  entryDateEl.value = saved || toInput(today);
  localStorage.setItem("infieldEntryDate", entryDateEl.value);
  entryDateEl.addEventListener("change", ()=>{
    if (entryDateEl.value){
      localStorage.setItem("infieldEntryDate", entryDateEl.value);
      updatePlanHeader();
    }
  });
})();
function toInput(d){ const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),da=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${da}`; }
function fromInput(s){ const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); }
function computeBaseMonday(entryDate){
  const day=entryDate.getDay(); const delta=(day===0? -6 : 1-day);
  const monday=new Date(entryDate); monday.setHours(0,0,0,0); monday.setDate(entryDate.getDate()+delta);
  return monday;
}
function weekStartEnd(weekNumber){
  const entryVal = localStorage.getItem("infieldEntryDate");
  const entryDate = entryVal ? fromInput(entryVal) : new Date();
  const baseMonday = computeBaseMonday(entryDate);
  const start = new Date(baseMonday); start.setDate(baseMonday.getDate()+7*(weekNumber-1));
  const end = new Date(start); end.setDate(start.getDate()+6);
  return { start, end };
}
const WD=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const MO=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
function fmtFull(d){ return `${WD[d.getDay()]} ${MO[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`; }

/* =========================================================
   NUMBERING
   ========================================================= */
function buildNumberingMaps(){
  const sectionNum = new Map();
  const itemNum = new Map();
  LANGUAGE_SECTIONS.forEach((sec,si)=>{
    const sNo = si+1; sectionNum.set(sec.id, sNo);
    sec.items.forEach((it,ii)=> itemNum.set(it.id, { sec:sNo, idx: ii+1 }) );
  });
  return { sectionNum, itemNum };
}

/* =========================================================
   RENDER: SOURCE LISTS (PMG & LANGUAGE)
   ========================================================= */
const pmgSource = document.getElementById("pmgSource");
const languageSource = document.getElementById("languageSource");

function renderSources(){
  /* PMG as a collapsed accordion under ‚ÄúChapter 7 Topics‚Äù */
  pmgSource.innerHTML = "";
  const pmgSection = document.createElement("div");
  pmgSection.className = "section collapsed"; // collapsed by default
  pmgSection.dataset.sectionId = "pmg-ch7";
  const pmgHeader = document.createElement("div");
  pmgHeader.className = "section-header";
  pmgHeader.innerHTML = `<span class="arrow">‚ñ∂</span><span>Chapter 7 Topics</span>`;
  pmgHeader.addEventListener("click", ()=> pmgSection.classList.toggle("collapsed"));
  pmgSection.appendChild(pmgHeader);
  const pmgList = document.createElement("ul");
  pmgList.className = "section-items source-list";
  PMG_TOPICS.forEach(t=>{
    pmgList.appendChild(buildSourceLi({id:t.id,title:t.title,link:t.link}, "pmg"));
  });
  pmgSection.appendChild(pmgList);
  pmgSource.appendChild(pmgSection);

  /* Language sections as accordions (collapsed by default) */
  languageSource.innerHTML="";
  const { sectionNum } = buildNumberingMaps();
  LANGUAGE_SECTIONS.forEach(sec=>{
    const sWrap = document.createElement("div");
    sWrap.className = "section collapsed";
    sWrap.dataset.sectionId = sec.id;
    const header = document.createElement("div");
    header.className = "section-header";
    header.innerHTML = `<span class="arrow">‚ñ∂</span><span>${sectionNum.get(sec.id)}. ${sec.title}</span>`;
    header.addEventListener("click", ()=> sWrap.classList.toggle("collapsed"));
    sWrap.appendChild(header);
    const items = document.createElement("ul");
    items.className = "section-items source-list";
    sec.items.forEach((it, index)=>{
      const numberedTitle = `${sectionNum.get(sec.id)}.${index+1} ${it.title}`;
      items.appendChild(buildSourceLi({id:it.id,title:numberedTitle,link:it.link}, "skill"));
    });
    sWrap.appendChild(items);
    languageSource.appendChild(sWrap);
  });

  refreshAddButtons();
  refreshAllCompletionDisplays(); // ensure source cards show current counts on render
}

function buildSourceLi(item, kind){
  const li = document.createElement("li");
  li.dataset.itemId = item.id;
  const card = document.createElement("div"); card.className="card";
  const top = document.createElement("div"); top.className="card-row top";
  /* Source row: [+] then title (no link/move here) */
  const actionsLeft = document.createElement("div"); actionsLeft.className="card-actions-left";
  const btn = document.createElement("button"); btn.className="add-btn"; btn.textContent="+";
  actionsLeft.appendChild(btn);
  const title = document.createElement("div"); title.className="card-title";
  const titleText = document.createElement("span"); titleText.className="card-title-text"; titleText.textContent=item.title;
  title.appendChild(titleText);
  top.appendChild(actionsLeft);
  top.appendChild(title);
  card.appendChild(top);

  /* NEW: completion line under source card, kept in sync by updateCompletionDisplays */
  const line = document.createElement("div");
  line.className = "completion-line";
  line.dataset.compId = item.id;
  (function initSourceLine(){
    const count = getCount(item.id);
    line.textContent = count > 0 ? `Completed ${count} ${count===1 ? "time" : "times"}` : "";
  })();
  card.appendChild(line);

  btn.addEventListener("click", (e)=>{
    e.stopPropagation();
    if (btn.disabled) return;
    if (kind==="pmg") addPMGToPlan(item);
    else addSkillToPlan(item);
  });
  li.appendChild(card);
  return li;
}

/* =========================================================
   PLAN RENDER & ACTIONS (open-circle check + reordered)
   ========================================================= */
const planPMG   = document.getElementById("planPMG");
const planSkills= document.getElementById("planSkills");
const planEval  = document.getElementById("planEval");
const stickyMini= document.getElementById("stickyMini");

function refreshNavButtons(){
  const prevBtn = document.getElementById("prevWeek");
  const nextBtn = document.getElementById("nextWeek");
  if (!prevBtn || !nextBtn) return;
  prevBtn.disabled = activeWeek <= 1;
  nextBtn.disabled = activeWeek >= WEEK_COUNT;
  prevBtn.title = prevBtn.disabled ? "You are on Week 1" : "";
  nextBtn.title = nextBtn.disabled ? "You are on Week 12" : "";
}

function updatePlanHeader(){
  const { start, end } = weekStartEnd(activeWeek);
  document.getElementById("planTitle").textContent = `Week ${activeWeek} Study Plan`;
  document.getElementById("planDates").textContent = `${fmtFull(start)} ‚Äì ${fmtFull(end)}`;
  stickyMini.textContent = `‚Üí Week ${activeWeek} Study Plan`;
}

function renderPlan(){
  updatePlanHeader();

  // PMG (single)
  planPMG.innerHTML="";
  const pmgSet = readSet(getFavKeyPMG(activeWeek));
  const chosenId = pmgSet.values().next().value;
  if (chosenId){
    const topic = PMG_TOPICS.find(t=>t.id===chosenId);
    if (topic){
      planPMG.appendChild(buildPlanLi(topic, "pmg", null)); // no number for PMG
    }
  }

  // Skills (unlimited)
  planSkills.innerHTML="";
  const skillSet = readSet(getFavKeySkill(activeWeek));
  const { itemNum } = buildNumberingMaps();
  Array.from(skillSet).forEach(id=>{
    const item = findItemById(id);
    if (item){
      const numObj = itemNum.get(item.id); // {sec, idx}
      const displayNum = numObj ? `${numObj.sec}.${numObj.idx}` : null;
      planSkills.appendChild(buildPlanLi(item, "skill", displayNum));
    }
  });

  // Evaluation (always present)
  planEval.innerHTML="";
  planEval.appendChild(buildEvalLi());
  refreshAddButtons();
  refreshAddOpenButtons();
}

function findItemById(id){
  for (const sec of LANGUAGE_SECTIONS){
    const found = sec.items.find(i=>i.id===id);
    if (found) return found;
  }
  return null;
}

function buildPlanLi(item, kind, displayNum){
  const li = document.createElement("li");
  li.dataset.planId = item.id;
  const card = document.createElement("div"); card.className="card in-plan";

  /* ---- TOP ROW: remove (left) + circle-check + [num + title] + right actions (link + move) ---- */
  const top = document.createElement("div"); top.className="card-row top";

  const actionsLeft = document.createElement("div"); actionsLeft.className="card-actions-left";
  const remove = document.createElement("button"); remove.className="remove-btn"; remove.title="Remove"; remove.textContent="‚Äì";
  actionsLeft.appendChild(remove);

  // Circle check (open/filled)
  const circle = document.createElement("button");
  circle.className = "circle-check";
  circle.setAttribute("role","checkbox");
  circle.setAttribute("aria-checked","false");
  circle.setAttribute("title","Mark completed");
  circle.innerHTML = '<span class="mark">‚úì</span>';

  // Title group: number + text
  const title = document.createElement("div"); title.className="card-title";
  const numSpan = document.createElement("span"); numSpan.className="card-num";
  if (displayNum) numSpan.textContent = displayNum; else numSpan.style.display = "none";
  const titleText = document.createElement("span"); titleText.className="card-title-text"; titleText.textContent = item.title;
  title.appendChild(numSpan); title.appendChild(titleText);

  // Right actions: link + move
  const right = document.createElement("div"); right.className="right-actions";
  const linkA = document.createElement("a");
  linkA.className="ext-link"; linkA.textContent="‚Üó"; linkA.href=item.link||"#"; linkA.target="_blank"; linkA.rel="noopener noreferrer";
  linkA.dataset.linkId=item.id;
  const moveNext = document.createElement("button"); moveNext.className="move-next"; moveNext.title="Move or repeat to next week";
  right.appendChild(linkA); right.appendChild(moveNext);

  top.appendChild(actionsLeft);
  top.appendChild(circle);
  top.appendChild(title);
  top.appendChild(right);
  card.appendChild(top);

  /* ---- COMPLETION LINE ---- */
  const line = document.createElement("div"); line.className="completion-line"; line.dataset.compId = item.id;
  card.appendChild(line);

  // load per-week check state
  const wkState = readObj(getWeekStateKey(activeWeek));
  let isChecked = !!wkState[item.id];
  applyCheckUI(isChecked, circle, card, line, item.id);

  // Toggle handlers for circle (click/keyboard)
  circle.addEventListener("click", ()=>toggleCheck(item.id));
  circle.addEventListener("keydown", (e)=>{
    if (e.key === " " || e.key === "Enter"){ e.preventDefault(); toggleCheck(item.id); }
  });
  function toggleCheck(id){
    const state = readObj(getWeekStateKey(activeWeek));
    const now = !state[id];
    state[id] = now; writeObj(getWeekStateKey(activeWeek), state);
    if (now) incCount(id); else decCount(id);
    isChecked = now;
    applyCheckUI(isChecked, circle, card, line, id);
    refreshMoveNextButton(moveNext, item, kind, isChecked);
  }

  remove.addEventListener("click", ()=>{
    if (kind==="pmg"){
      const set = readSet(getFavKeyPMG(activeWeek));
      set.clear(); writeSet(getFavKeyPMG(activeWeek), set);
    } else {
      const set = readSet(getFavKeySkill(activeWeek));
      set.delete(item.id); writeSet(getFavKeySkill(activeWeek), set);
    }
    refreshUI();
  });

  refreshMoveNextButton(moveNext, item, kind, isChecked);
  moveNext.addEventListener("click", ()=> handleMoveNext(item, kind, isChecked));

  li.appendChild(card);
  return li;
}

function applyCheckUI(isChecked, circleBtn, card, lineEl, itemId){
  circleBtn.setAttribute("aria-checked", isChecked ? "true" : "false");
  card.classList.toggle("completed", isChecked);
  const count = getCount(itemId);
  lineEl.textContent = count>0 ? `Completed ${count} ${count===1 ? "time" : "times"}` : "";
}

function refreshMoveNextButton(btn, item, kind, isChecked){
  const nextWeek = activeWeek + 1;
  if (nextWeek > WEEK_COUNT){
    btn.disabled = true; btn.classList.toggle("is-repeat", isChecked);
    btn.textContent = isChecked ? "‚ü≥" : "‚Üí";
    btn.title = "You are on Week 12. There is no next week.";
    return;
  }
  let alreadyThere=false;
  if (kind==="pmg"){
    const nset = readSet(getFavKeyPMG(nextWeek));
    const chosen = nset.values().next().value;
    alreadyThere = (chosen === item.id);
  }else{
    const nset = readSet(getFavKeySkill(nextWeek));
    alreadyThere = nset.has(item.id);
  }
  btn.textContent = isChecked ? "‚ü≥" : "‚Üí";
  btn.classList.toggle("is-repeat", isChecked);
  btn.disabled = alreadyThere;
  btn.title = alreadyThere ? "Already in next week's plan." : (isChecked ? "Repeat in next week" : "Move to next week");
}

async function handleMoveNext(item, kind, isChecked){
  const nextWeek = activeWeek + 1;
  if (nextWeek > WEEK_COUNT) return; // button is disabled anyway

  if (kind==="pmg"){
    const nset = readSet(getFavKeyPMG(nextWeek));
    const currentNext = nset.values().next().value || null;
    if (currentNext && currentNext !== item.id){
      const ok = await appConfirm(`Next week already has a PMG topic. Replace it with "${item.title}"?`, "Replace PMG for next week");
      if (!ok) return;
      nset.clear();
    }
    nset.add(item.id); writeSet(getFavKeyPMG(nextWeek), nset);
    if (!isChecked){
      const cset = readSet(getFavKeyPMG(activeWeek)); cset.clear(); writeSet(getFavKeyPMG(activeWeek), cset);
      const state = readObj(getWeekStateKey(activeWeek)); Object.keys(state).forEach(k=>{ if(k===item.id) state[k]=false; }); writeObj(getWeekStateKey(activeWeek), state);
    }
    const nstate = readObj(getWeekStateKey(nextWeek)); nstate[item.id] = false; writeObj(getWeekStateKey(nextWeek), nstate);
  } else {
    const nset = readSet(getFavKeySkill(nextWeek));
    if (!nset.has(item.id)) nset.add(item.id); writeSet(getFavKeySkill(nextWeek), nset);
    if (!isChecked){
      const cset = readSet(getFavKeySkill(activeWeek)); cset.delete(item.id); writeSet(getFavKeySkill(activeWeek), cset);
      const state = readObj(getWeekStateKey(activeWeek)); state[item.id] = false; writeObj(getWeekStateKey(activeWeek), state);
    }
    const nstate = readObj(getWeekStateKey(nextWeek)); nstate[item.id] = false; writeObj(getWeekStateKey(nextWeek), nstate);
  }
  refreshUI();
}

/* ===== Evaluation special card (open-circle; no counts) ===== */
function buildEvalLi(){
  const li = document.createElement("li");
  const card = document.createElement("div"); card.className="card in-plan";
  const top = document.createElement("div"); top.className="card-row top";

  // circle check
  const circle = document.createElement("button");
  circle.className = "circle-check";
  circle.setAttribute("role","checkbox");
  circle.setAttribute("aria-checked","false");
  circle.setAttribute("title","Mark completed");
  circle.innerHTML = '<span class="mark">‚úì</span>';

  const title = document.createElement("div"); title.className="card-title";
  const numSpan = document.createElement("span"); numSpan.className="card-num"; numSpan.style.display="none";
  const titleText = document.createElement("span"); titleText.className="card-title-text"; titleText.textContent="Complete a Language Study Evaluation";
  title.appendChild(numSpan); title.appendChild(titleText);

  const right = document.createElement("div"); right.className="right-actions";
  const a = document.createElement("a"); a.className="ext-link"; a.textContent="‚Üó"; a.href="https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=figure2_title1-figure2_p8#figure2_title1"; a.target="_blank"; a.rel="noopener noreferrer"; a.dataset.linkId="evaluation";
  right.appendChild(a);

  top.appendChild(circle); top.appendChild(title); top.appendChild(right);
  card.appendChild(top);

  const line = document.createElement("div"); line.className="completion-line"; card.appendChild(line);

  let isOn = localStorage.getItem(EVAL_KEY(activeWeek)) === "true";
  applyCheckUI(isOn, circle, card, line, "evaluation"); // counts ignored for evaluation
  circle.addEventListener("click", ()=>{
    isOn = !isOn; localStorage.setItem(EVAL_KEY(activeWeek), String(isOn));
    applyCheckUI(isOn, circle, card, line, "evaluation");
  });
  circle.addEventListener("keydown",(e)=>{ if(e.key===" "||e.key==="Enter"){ e.preventDefault(); circle.click(); }});

  li.appendChild(card);
  return li;
}

/* =========================================================
   ADD / DISABLE LOGIC FOR SOURCE BUTTONS
   ========================================================= */
function refreshAddButtons(){
  const pmgSet = readSet(getFavKeyPMG(activeWeek));
  const chosen = pmgSet.values().next().value || null;
  document.querySelectorAll('#pmgSource li[data-item-id]').forEach(li=>{
    const id = li.dataset.itemId;
    const btn = li.querySelector('.add-btn');
    btn.disabled = (id === chosen); // only the chosen PMG disabled
  });

  const skillSet = readSet(getFavKeySkill(activeWeek));
  document.querySelectorAll('#languageSource li[data-item-id]').forEach(li=>{
    const id = li.dataset.itemId;
    const btn = li.querySelector('.add-btn');
    btn.disabled = skillSet.has(id);
  });
}

/* =========================================================
   LANGUAGE ACCORDION CONTROLS
   ========================================================= */
document.getElementById("expandAllLanguage").addEventListener("click", () => {
  document.querySelectorAll("#languageSource .section").forEach(sec => sec.classList.remove("collapsed"));
});
document.getElementById("collapseAllLanguage").addEventListener("click", () => {
  document.querySelectorAll("#languageSource .section").forEach(sec => sec.classList.add("collapsed"));
});

/* =========================================================
   ADD TO PLAN (from source)
   ========================================================= */
async function addPMGToPlan(topic){
  const set = readSet(getFavKeyPMG(activeWeek));
  // If nothing selected yet, just add it
  if (set.size === 0){
    set.add(topic.id);
    writeSet(getFavKeyPMG(activeWeek), set);
    refreshUI();
    if (isPickerOpen()) refreshPickerAddButtons(getPickerBody(), 'pmg');
    return;
  }
  // Otherwise, confirm replacement
  closePicker();
  const ok = await appConfirm(
    `You can only have one study focus in this section. Would you like to change it to "${topic.title}"?`,
    "Replace Study Focus"
  );
  if (!ok) return;

  // Replace existing PMG topic
  set.clear();
  set.add(topic.id);
  writeSet(getFavKeyPMG(activeWeek), set);

  // Clear checked state for PMG items this week
  const state = readObj(getWeekStateKey(activeWeek));
  Object.keys(state).forEach(k => { if (k.startsWith("pmg")) state[k]=false; });
  writeObj(getWeekStateKey(activeWeek), state);

  refreshUI();
  if (isPickerOpen()) refreshPickerAddButtons(getPickerBody(), 'pmg');
}

function addSkillToPlan(item){
  const set = readSet(getFavKeySkill(activeWeek));
  if (!set.has(item.id)){ set.add(item.id); writeSet(getFavKeySkill(activeWeek), set); refreshUI();if (isPickerOpen()) refreshPickerAddButtons(getPickerBody(), 'skill');}
}

/* =========================================================
   COPY PLAN ‚Üí MARKDOWN (with dates & numbering)
   ========================================================= */
document.getElementById("copyPlan").addEventListener("click", () => {
  const { start, end } = weekStartEnd(activeWeek);
  const planTitle = `## Week ${activeWeek} Study Plan`;
  const datesLine = `_${fmtFull(start)} ‚Äì ${fmtFull(end)}_`;

  const pmgSet = readSet(getFavKeyPMG(activeWeek));
  const pmgId = pmgSet.values().next().value;
  const pmgTopic = PMG_TOPICS.find(t => t.id === pmgId);

  const { itemNum } = buildNumberingMaps();
  const skillSet = readSet(getFavKeySkill(activeWeek));
  const skillsLines = Array.from(skillSet).map(id=>{
    const item = findItemById(id) || { title:id };
    const num = itemNum.get(id);
    const t = num ? `${num.sec}.${num.idx} ${item.title}` : item.title;
    return `- ${t}`;
  });

  const lines = [
    planTitle, datesLine, "",
    "### Preach My Gospel study section", ...(pmgTopic ? [`- ${pmgTopic.title}`] : []),
    "", "### Language Skills", ...(skillsLines.length ? skillsLines : []),
    "", "### Evaluate Your Language Study", "- Complete a Language Study Evaluation"
  ];

  const text = lines.join("\n");
  navigator.clipboard?.writeText(text)
    .then(()=> { showToast("Plan copied to clipboard"); })
    .catch(()=>{
      const ta = document.createElement("textarea");
      ta.value = text; document.body.appendChild(ta); ta.select();
      try { document.execCommand("copy"); showToast("Plan copied to clipboard"); }
      catch { showToast("Copy failed. You can select and copy manually."); }
      finally { document.body.removeChild(ta); }
    });
});

/* =========================================================
   CLEAR ACTIONS & NAV (BUG-FIXED)
   ========================================================= */
document.getElementById("clearWeek").addEventListener("click", async ()=>{
  const { start, end } = weekStartEnd(activeWeek);

const msg =
  `Clear Week ${activeWeek}?\n\n` +
  `This will:\n` +
  `‚Ä¢ Remove all items from this week‚Äôs plan\n` +
  `‚Ä¢ Uncheck anything you marked ‚Äúcompleted‚Äù this week (including Evaluation)\n` +
  `‚Ä¢ Reduce the ‚ÄúCompleted X times‚Äù total for items you checked this week by 1\n\n` +
  `Week dates: ${fmtFull(start)} ‚Äì ${fmtFull(end)}\n\n` +
  `This cannot be undone. Continue?`;
  const ok = await appConfirm(msg, "Clear Week");
  if (!ok) return;

  // Decrement counts for any items marked completed this week (not evaluation)
  const state = readObj(getWeekStateKey(activeWeek));
  Object.entries(state).forEach(([itemId, isOn])=>{
    if (isOn && itemId !== "evaluation") decCount(itemId);
  });

  // Clear this week selections/state
  writeSet(getFavKeyPMG(activeWeek),   new Set());
  writeSet(getFavKeySkill(activeWeek), new Set());
  localStorage.removeItem(EVAL_KEY(activeWeek));
  localStorage.removeItem(getWeekStateKey(activeWeek));

  refreshUI();
  showToast(`Week ${activeWeek} cleared`);
});

document.getElementById("clearAll").addEventListener("click", async ()=>{

const msg =
  `Clear ALL weeks (Weeks 1‚Äì${WEEK_COUNT})?\n\n` +
  `This will:\n` +
  `‚Ä¢ Remove all items from every week‚Äôs plan\n` +
  `‚Ä¢ Uncheck everything that was marked ‚Äúcompleted‚Äù in any week\n` +
  `‚Ä¢ Reset every item‚Äôs ‚ÄúCompleted X times‚Äù total to 0\n\n` +
  `This cannot be undone. Continue?`;

  const ok = await appConfirm(msg, "Clear All Weeks");
  if (!ok) return;

  for (let w=1; w<=WEEK_COUNT; w++){
    writeSet(getFavKeyPMG(w),   new Set());
    writeSet(getFavKeySkill(w), new Set());
    localStorage.removeItem(EVAL_KEY(w));
    localStorage.removeItem(getWeekStateKey(w));
  }
  localStorage.removeItem(COUNTS_KEY);

  refreshUI();
  showToast("All weeks cleared");
});

document.getElementById("nextWeek").addEventListener("click", () => {
  if (activeWeek >= WEEK_COUNT) return;
  setActiveWeek(activeWeek + 1);
  window.scrollTo({ top: 0, behavior: "smooth" });
});
document.getElementById("prevWeek").addEventListener("click", () => {
  if (activeWeek <= 1) return;
  setActiveWeek(activeWeek - 1);
  window.scrollTo({ top: 0, behavior: "smooth" });
});

/* =========================================================
   STICKY MINI HEADER SCROLL
   ========================================================= */
const planWrapper = document.getElementById("planWrapper");
const io = new IntersectionObserver((entries)=>{
  entries.forEach(e=>{
    stickyMini.classList.toggle("show", !e.isIntersecting);
  });
}, { rootMargin: "-70px 0px 0px 0px", threshold: 0 });
io.observe(planWrapper);
stickyMini.addEventListener("click", ()=>{
  planWrapper.scrollIntoView({behavior:"smooth",block:"start"});
});

/* =========================================================
   COMPLETION LINE REFRESH
   ========================================================= */
function updateCompletionDisplays(itemId){
  const count = getCount(itemId);
  document.querySelectorAll(`.completion-line[data-comp-id="${itemId}"]`).forEach(el=>{
    el.textContent = count>0 ? `Completed ${count} ${count===1?"time":"times"}` : "";
  });
}

/* =========================================================
   INFO POPOVER (Option C) ‚Äî fixed positioning under ‚ìò
   ========================================================= */
const noticeBtn = document.getElementById("noticeBtn");
const noticePop = document.getElementById("noticePop");
document.addEventListener("click", (e)=>{
  if (noticeBtn.contains(e.target)){
    const open = noticePop.classList.toggle("show");
    noticeBtn.setAttribute("aria-expanded", open?"true":"false");
    if (open) {
      const rect = noticeBtn.getBoundingClientRect();
      const popWidth = noticePop.offsetWidth;
      let left = rect.left + rect.width/2 - popWidth/2;
      left = Math.max(8, Math.min(left, window.innerWidth - popWidth - 8));
      noticePop.style.top  = `${rect.bottom + 8}px`;
      noticePop.style.left = `${left}px`;
    }
    return;
  }
  // click outside closes
  if (!noticePop.contains(e.target)){
    noticePop.classList.remove("show");
    noticeBtn.setAttribute("aria-expanded","false");
  }
});

/* ===== Custom alert/confirm helpers ===== */
function appAlert(message, {title} = {}){
  return new Promise(resolve => {
    openAppModal({ message, title, mode: 'alert', onOk: () => resolve() });
  });
}
function appConfirm(message, title = "Confirm"){
  return new Promise(resolve => {
    openAppModal({ message, title, mode: 'confirm', onOk: () => resolve(true), onCancel: () => resolve(false) });
  });
}
function openAppModal({ message, title, mode, onOk, onCancel }){
  const modal = document.getElementById('appModal');
  const msgEl = document.getElementById('appModalMessage');
  const titleEl = modal.querySelector('.app-modal__title');
  const btnOk = document.getElementById('appModalOk');
  const btnCancel = document.getElementById('appModalCancel');
  const btnClose = modal.querySelector('.app-modal__close');
  const backdrop = modal.querySelector('.app-modal__backdrop');

  // set title & message
  if (title) titleEl.textContent = title;
  msgEl.textContent = message;

  // show/hide Cancel depending on mode
  btnCancel.style.display = (mode === 'confirm') ? 'inline-block' : 'none';

  // open
  modal.setAttribute('aria-hidden', 'false');

  // focus management: focus OK
  setTimeout(() => btnOk.focus(), 0);

  // cleanup replaces nodes to drop old handlers
  const cleanup = () => {
    modal.setAttribute('aria-hidden', 'true');
    btnOk.replaceWith(btnOk.cloneNode(true));
    btnCancel.replaceWith(btnCancel.cloneNode(true));
    btnClose.replaceWith(btnClose.cloneNode(true));
    backdrop.replaceWith(backdrop.cloneNode(true));
  };

  // re-query after clone for fresh nodes, then wire handlers
  const wire = () => {
    const ok = document.getElementById('appModalOk');
    const cancel = document.getElementById('appModalCancel');
    const close = modal.querySelector('.app-modal__close');
    const back = modal.querySelector('.app-modal__backdrop');

    ok.addEventListener('click', () => { cleanup(); onOk && onOk(); });
    cancel.addEventListener('click', () => { cleanup(); onCancel && onCancel(); });
    close.addEventListener('click', () => { cleanup(); (onCancel || onOk)?.(); });
    back.addEventListener('click', () => { cleanup(); (onCancel || onOk)?.(); });

    modal.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { e.preventDefault(); cleanup(); (onCancel || onOk)?.(); }
    });
  };
  wire();
}

/* ===== Toast ===== */
let toastTimer = null;
function showToast(message, timeout = 2000){
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => {
    toast.classList.remove("show");
  }, timeout);
}

/* ===== Refresh all source completion lines after rendering ===== */
function refreshAllCompletionDisplays(){
  PMG_TOPICS.forEach(t => updateCompletionDisplays(t.id));
  LANGUAGE_SECTIONS.forEach(sec => { sec.items.forEach(it => updateCompletionDisplays(it.id)); });
}


/* =========================================================
 ADD PICKER MODAL + ADD BUTTONS
 ========================================================= */

// --- Helpers to open/close the picker modal
function openPicker(kind) {
  const modal   = document.getElementById('pickerModal');
  const titleEl = document.getElementById('pickerTitle');
  const bodyEl  = document.getElementById('pickerBody');

  // Reset body
  bodyEl.innerHTML = '';

  if (kind === 'pmg') {
    titleEl.textContent = 'Add Chapter 7 topics';
    renderPMGPicker(bodyEl);
  } else {
    titleEl.textContent = 'Add language skills';
    renderLanguagePicker(bodyEl);
  }

  // Open modal
  modal.setAttribute('aria-hidden', 'false');

  // Wire close actions for this open
  const btnClose  = document.getElementById('pickerClose');
  const btnX      = modal.querySelector('.app-modal__close');
  const backdrop  = modal.querySelector('.app-modal__backdrop');

  const close = () => {
    modal.setAttribute('aria-hidden', 'true');
    // Cleanup handlers by cloning (same approach you use for app modal)
    btnClose.replaceWith(btnClose.cloneNode(true));
    btnX.replaceWith(btnX.cloneNode(true));
    backdrop.replaceWith(backdrop.cloneNode(true));
  };

  // Re-query cloned nodes and attach listeners
  const wire = () => {
    const cClose   = document.getElementById('pickerClose');
    const cX       = modal.querySelector('.app-modal__close');
    const cBackdrop= modal.querySelector('.app-modal__backdrop');

    cClose.addEventListener('click', close);
    cX.addEventListener('click', close);
    cBackdrop.addEventListener('click', close);

    // ESC to close
    modal.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { e.preventDefault(); close(); }
    });
  };
  wire();
}


function closePicker() {
  const modal = document.getElementById('pickerModal');
  if (modal && modal.getAttribute('aria-hidden') === 'false') {
    // Simulate clicking Close
    const btnClose = document.getElementById('pickerClose');
    if (btnClose) btnClose.click();
  }
}


function renderPMGPicker(container) {
  // Flat list of PMG topics, no accordion header
  const ul = document.createElement('ul');
  ul.className = 'source-list';
  PMG_TOPICS.forEach(t => {
    ul.appendChild(buildSourceLi({ id: t.id, title: t.title, link: t.link }, 'pmg'));
  });
  container.appendChild(ul);

  // Disable "+ Add" buttons for items already in this week
  refreshPickerAddButtons(container, 'pmg');
  // Sync completion lines
  refreshAllCompletionDisplays();
}

function renderLanguagePicker(container) {
  // Replicate the full Language section with accordions + expand/collapse controls
  const controls = document.createElement('div');
  controls.className = 'accordion-controls';
  controls.innerHTML = `
    <button class="btn" id="pickerExpand">Expand all</button>
    <button class="btn" id="pickerCollapse">Collapse all</button>
  `;
  container.appendChild(controls);

  const { sectionNum } = buildNumberingMaps();

  LANGUAGE_SECTIONS.forEach(sec => {
    const sWrap = document.createElement('div');
    sWrap.className = 'section collapsed'; // collapsed by default
    sWrap.dataset.sectionId = sec.id;

    const header = document.createElement('div');
    header.className = 'section-header';
    header.innerHTML = `<span class="arrow">‚ñ∂</span><span>${sectionNum.get(sec.id)}. ${sec.title}</span>`;
    header.addEventListener('click', () => sWrap.classList.toggle('collapsed'));
    sWrap.appendChild(header);

    const items = document.createElement('ul');
    items.className = 'section-items source-list';

    sec.items.forEach((it, index) => {
      const numberedTitle = `${sectionNum.get(sec.id)}.${index+1} ${it.title}`;
      items.appendChild(buildSourceLi({ id: it.id, title: numberedTitle, link: it.link }, 'skill'));
    });

    sWrap.appendChild(items);
    container.appendChild(sWrap);
  });

  // Wire local expand/collapse for the modal only
  container.querySelector('#pickerExpand').addEventListener('click', () => {
    container.querySelectorAll('.section').forEach(sec => sec.classList.remove('collapsed'));
  });
  container.querySelector('#pickerCollapse').addEventListener('click', () => {
    container.querySelectorAll('.section').forEach(sec => sec.classList.add('collapsed'));
  });

  // Disable "+ Add" buttons for items already in this week
  refreshPickerAddButtons(container, 'skill');
  // Sync completion lines
  refreshAllCompletionDisplays();
}

function refreshPickerAddButtons(container, kind) {
  if (kind === 'pmg') {
    const pmgSet = readSet(getFavKeyPMG(activeWeek));
    const chosen = pmgSet.values().next().value || null;
    container.querySelectorAll('li[data-item-id]').forEach(li => {
      const id = li.dataset.itemId;
      const btn = li.querySelector('.add-btn');
      if (btn) btn.disabled = (id === chosen);
    });
  } else {
    const skillSet = readSet(getFavKeySkill(activeWeek));
    container.querySelectorAll('li[data-item-id]').forEach(li => {
      const id = li.dataset.itemId;
      const btn = li.querySelector('.add-btn');
      if (btn) btn.disabled = skillSet.has(id);
    });
  }
}

// Add-button click handlers (open the picker)
document.getElementById('addPMG').addEventListener('click', () => openPicker('pmg'));
document.getElementById('addSkill').addEventListener('click', () => openPicker('skill'));

// Toggle empty/non-empty state for each box (controls button presentation)
function refreshAddOpenButtons() {
  const pmgBox   = document.getElementById('pmgBox');
  const skillBox = document.getElementById('skillBox');
  if (pmgBox)   pmgBox.classList.toggle('empty',   document.getElementById('planPMG').children.length === 0);
  if (skillBox) skillBox.classList.toggle('empty', document.getElementById('planSkills').children.length === 0);
}

// Is the picker currently open?
function isPickerOpen() {
  const m = document.getElementById('pickerModal');
  return m && m.getAttribute('aria-hidden') === 'false';
}
// Get the picker body element (where items are rendered)
function getPickerBody() {
  return document.getElementById('pickerBody');
}

/* =========================================================
   INIT / REFRESH
   ========================================================= */
function refreshUI(){
  renderPlan();
  refreshAddButtons();
  refreshAllCompletionDisplays();
  refreshNavButtons();
}

function setActiveWeek(w){
  activeWeek=w; localStorage.setItem("activeWeek",String(w)); weekSelect.value=String(w);
  refreshUI();
}

function init(){
  renderSources();
  refreshUI();
}
init();
</script>

<!-- App Modal (replaces native alert/confirm) -->
<div id="appModal" class="app-modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="app-modal__backdrop"></div>
  <div class="app-modal__dialog" role="document">
    <div class="app-modal__header">
      <div class="app-modal__title">Infield Planner</div>
      <button class="app-modal__close" type="button" aria-label="Close">√ó</button>
    </div>
    <div class="app-modal__body" id="appModalMessage"></div>
    <div class="app-modal__footer">
      <button class="btn" id="appModalCancel" type="button">Cancel</button>
      <button class="btn" id="appModalOk" type="button">OK</button>
    </div>
  </div>
</div>


<!-- Picker Modal (for Add buttons) -->
<div id="pickerModal" class="app-modal app-modal--picker" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="app-modal__backdrop"></div>
  <div class="app-modal__dialog" role="document">
    <div class="app-modal__header">
      <div class="app-modal__title" id="pickerTitle">Select items</div>
      <button class="app-modal__close" type="button" aria-label="Close">√ó</button>
    </div>
    <div class="app-modal__body" id="pickerBody"></div>
    <div class="app-modal__footer">
      <button class="btn" id="pickerClose" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

</body>
</html>
