<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Infield Language Program Planning Tool</title>

<style>
/* ===== THEME & BASE ===== */
:root{
  --text:#0f172a; --muted:#6b7280; --border:#cbd5e1; --bg:#ffffff;
  --gray-plan-bg:#f3f4f6;
  --green-border:#298e44; --green-bg:#dff3e6;
  --blue-border:#027da5; --blue-bg:#e3f2fd;
  --yellow-border:#ffb81d; --yellow-bg:#fff4cf;
  --ok-bg:#22c55e; --ok-border:#15803d;
}
*{ box-sizing:border-box }
html, body { height:100%; }
body{
  margin:12px;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  line-height:1.5;
  font-size:17.5px;
  padding-bottom:30px; /* for sticky footer */
}
h1{margin:0 0 6px 0;font-size:1.8rem}
h2{margin:18px 0 6px;font-size:1.22rem}
h3{margin:10px 0 4px;font-size:1.02rem}
hr{margin:18px 0;border:none;border-top:1px solid var(--border)}
@media (max-width:480px){ h1{font-size:1.42rem;} }

/* ===== GLOBAL BUTTON NORMALIZATION ===== */
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding:6px 10px;        /* compact; keeps rows tight */
  line-height:1;           /* prevents extra vertical padding from fonts */
  border:1px solid var(--border);
  border-radius:8px;
  background:#fff;
  color:var(--text);
  cursor:pointer;
  font-size:.95rem;
  text-decoration:none;
  white-space:nowrap;
}
.btn:hover{ filter:brightness(0.98); }

/* Accent button for primary action (Add Custom Goal) */
.btn-accent{
  background:var(--blue-border);
  border-color:var(--blue-border);
  color:#fff;              /* makes label visible regardless of theme */
}
.btn-accent:hover{ filter:brightness(0.97); }

/* ===== TOP ROW ===== */
.top-row{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;flex-wrap:wrap}
.notice-line{font-size:.95rem}
.notice-info{ display:inline-flex;align-items:center;gap:6px; font-size:.95rem;color:#222 }
.notice-info button{ border:none;background:transparent;cursor:pointer; font-size:1rem;line-height:1;padding:0 2px;color:#0b6aa5 }
.notice-pop{
  position:fixed; width: 700px; max-width:90vw; background:#fff; border:1px solid var(--border);
  border-radius:8px; padding:10px 12px; box-shadow:0 8px 24px rgba(0,0,0,.12);
  font-size:.95rem; z-index:20; display:none;
}
.notice-pop.show{display:block}

/* ===== PASSWORD SCREEN ===== */
#password-screen{
  display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh;
}
#password-screen input, #password-screen button{
  padding:10px; font-size:1rem; margin-top:10px;
}

/* ===== PAGE CONTROLS (WEEK/DATE) ===== */
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;margin-bottom:12px}
.controls label{font-weight:600;font-size:.9rem}
.controls select,.controls input[type="date"]{
  padding:6px 8px;font-size:.95rem;border-radius:6px;border:1px solid var(--border)
}

/* ===== PLAN WRAPPER ===== */
.plan-wrapper{ border:2px solid #000;background:var(--gray-plan-bg); border-radius:10px;padding:10px;margin-bottom:14px }
.plan-title{font-weight:800;font-size:1.05rem}
.plan-dates{color:var(--muted);margin-top:1px;margin-bottom:6px;font-size:.9rem}

/* ===== DESKTOP GRID ===== */
.plan-grid{display:grid;grid-template-columns:1fr;gap:8px}
@media (min-width:800px){
  .plan-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    grid-template-areas:
      "pmg pmg"
      "skill skillLong"
      "eval eval";
    gap:8px;
  }
  #pmgBox{ grid-area: pmg; }
  #skillBox{ grid-area: skill; }
  #skillBoxLong{ grid-area: skillLong; }
  #evalBox{ grid-area: eval; }
}

/* ===== PLAN BOXES ===== */
.plan-box{border-radius:9px;padding:8px}
.plan-box h4{margin:0 0 2px;font-size:.97rem}
.green-box{ border:2px solid var(--green-border);  background:var(--green-bg) }
.blue-box { border:2px solid var(--blue-border);   background:var(--blue-bg) }
.yellow-box{border:2px solid var(--yellow-border); background:var(--yellow-bg)}
.plan-list{list-style:none;padding-left:0;margin:0}

/* Header row inside each plan box */
.plan-header{
  display:flex; align-items:center; justify-content:space-between; gap:8px;
}
.plan-box.empty .plan-header{ flex-direction:column; align-items:center; }
.plan-box.empty .plan-header h4{ margin-bottom:6px; }

/* Add button look in plan boxes */
.add-open{
  display:inline-flex; align-items:center; gap:6px;
  padding:8px 10px; font-size:1rem; line-height:1.1;
  border:0px solid var(--border); border-radius:8px; background:#fff; cursor:pointer;
}
.add-open .icon{ font-size:1.1rem; }
.plan-box:not(.empty) .add-open .label{ display:none; }
.plan-box:not(.empty) .add-open .icon{ font-size:2rem; line-height:1; }
.plan-box.empty .add-open{ padding:10px 14px; font-weight:700; }
.add-open.add-text{ background:transparent; border-color:currentColor; }
.green-box .add-open.add-text{ color:var(--green-border); }
.blue-box  .add-open.add-text{ color:var(--blue-border); }
.add-open:hover{ filter:brightness(0.97); }

/* ===== CARDS ===== */
.card{
  background:#fff; border:1px solid var(--border); border-radius:10px;
  padding:10px 12px; margin:8px 0; box-shadow:0 1px 2px rgba(0,0,0,.05);
}
.card-row{display:flex;gap:6px}
.card-row.top{align-items:flex-start}
.card-title{display:flex;align-items:flex-start;gap:6px;flex:1;min-width:0}
.card-title .card-num{ font-weight:400; font-size:.92rem; white-space:nowrap; line-height:1.1; }
.card-title .card-title-text{ font-weight:400; font-size:.9rem; line-height:1.25; white-space:normal; word-break:break-word }
.card-actions-left{display:flex;gap:6px;align-items:center}
.right-actions{display:flex;align-items:flex-start;gap:8px}

/* completion line */
.completion-line{color:var(--muted);font-size:.8rem;width:100%;margin-top:3px}

/* small buttons in cards */
.add-btn,.remove-btn,.move-next{
  padding:6px 10px; line-height:1; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer; font-size:.95rem;
}
.add-btn{ padding:2px 7px }
.remove-btn{ padding:2px 7px }

/* ext link only visible in plan; small & snug */
.ext-link{display:none;text-decoration:none;font-size:1.05rem;line-height:1}
.in-plan .ext-link{display:inline-flex}

/* icon-only move/repeat */
.move-next{
  background:transparent;border:none;min-width:24px;height:24px;
  display:inline-flex;align-items:center;justify-content:center;color:#111;padding:0;font-size:1.2rem
}
.move-next:hover{color:#0b6aa5}
.move-next.is-repeat{font-size:1.45rem}

/* circle checkbox */
.circle-check{
  width:20px;height:20px;min-width:20px;min-height:20px;border-radius:50%;
  border:2px solid #9ca3af;background:#fff;display:inline-flex;align-items:center;justify-content:center;
  cursor:pointer;line-height:1;font-size:.9rem;color:#fff; align-self:flex-start;
}
.circle-check[aria-checked="true"]{ background:var(--ok-bg); border-color:var(--ok-border); }
.circle-check .mark{display:none}
.circle-check[aria-checked="true"] .mark{display:block}
.completed .card-title-text{ text-decoration:line-through; color:var(--muted) }

/* ===== PLAN ACTIONS ===== */
.plan-actions{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:6px; margin-top:6px; }
.actions-left { justify-self:start; }
.actions-center{ justify-self:center; display:flex; gap:6px; flex-wrap:wrap; }
.actions-right{ justify-self:end; }
.nav-btn{ font-weight:800; display:inline-flex; align-items:center; gap:6px; }
.nav-btn .arrow{ font-weight:800; line-height:1; }
.nav-btn:disabled{ opacity:.35; cursor:not-allowed; }
.nav-btn:disabled .arrow, .nav-btn:disabled .label{ opacity:.35; }
@media (max-width:520px){ .nav-btn .label, .icon-btn .label{ display:none; } }

/* ===== ACCORDIONS ===== */
.section{margin-bottom:8px;border-bottom:1px dashed var(--border);padding-bottom:6px}
.section-header{cursor:pointer;font-size:.92rem;color:#334155;font-weight:600;display:flex;gap:6px;align-items:center}
.section-header .arrow{transition:transform .15s ease}
.section.collapsed .section-items{display:none}
.section.collapsed .section-header .arrow{transform:rotate(0deg)}
.section:not(.collapsed) .section-header .arrow{transform:rotate(90deg)}
.section-items{list-style:none;padding-left:0;margin-top:4px}
.source-list{list-style:none;margin:0;padding:0}
.source-list .card{padding:6px 8px;margin:5px 0}

/* ===== MODALS (APP / PICKER / CUSTOM GOAL) ===== */
.app-modal[aria-hidden="true"]{ display:none; }
.app-modal{
  position:fixed; inset:0; z-index:1000; display:grid; place-items:center;
}
.app-modal__backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
.app-modal__dialog{
  position:relative; width:min(700px,90vw); background:#fff; border:1px solid var(--border);
  border-radius:10px; box-shadow:0 12px 36px rgba(0,0,0,.22); overflow:hidden;
  max-height:90vh; display:flex; flex-direction:column;
}
.app-modal__header{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; background:var(--gray-plan-bg); border-bottom:1px solid var(--border);
}
.app-modal__title{ font-weight:800; }
.app-modal__close{ border:none; background:transparent; font-size:1.2rem; cursor:pointer; line-height:1; }

/* KEY: body has no padding so the toolbar can be tight; content gets padding */
.app-modal__body{
  padding:0;                 /* <-- remove vertical gaps around toolbar */
  font-size:.97rem; color:#111; white-space:pre-line; overflow:auto;
}
.app-modal__footer{ display:flex; gap:8px; justify-content:flex-end; padding:10px 12px; border-top:1px solid var(--border); }
@media (max-width:520px){ .app-modal__dialog{ width:min(480px,94vw); } }

/* Picker sits beneath confirm dialogs; custom-goal sits above */
.app-modal--picker{ z-index:900; }
.app-modal--customgoal{ z-index:1100; }
.app-modal--customgoal .app-modal__dialog{ width:min(520px,92vw); }

/* ===== PICKER TOOLBAR (tight, aligned, visible) ===== */
#pickerToolbar{
  display:flex; align-items:center; justify-content:space-between;
  gap:6px;
  margin:0;
  padding:8px 12px;
  border-bottom:1px solid var(--border);
  background:#fff;
}
#pickerToolbar .left,
#pickerToolbar .right{
  display:flex; align-items:center;
}
#pickerToolbar .right{ margin-left:auto; }
#pickerToolbar .btn{ padding:6px 10px; line-height:1; } /* ensure exact height */

/* Content area beneath toolbar gets the space */
#pickerContent{ padding:12px; }

/* ===== TOAST ===== */
.toast{
  position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
  background:#111; color:#fff; padding:10px 14px; border-radius:8px; font-size:.9rem;
  opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease; z-index:1200;
}
.toast.show{ opacity:.95; transform:translateX(-50%) translateY(0); }
@media (max-width:520px){ .toast{ width:calc(100vw - 24px); text-align:center; } }

/* ===== STICKY FOOTER BAR ===== */
.footer-bar{
  position:fixed; bottom:0; left:0; width:100%; height:30px;
  background-color:#003366; color:#fff; display:flex; align-items:center; justify-content:center;
  z-index:1000;
}

/* ===== HIDE THE BOTTOM STUDY TOPIC OPTIONS (picker-only) ===== */
#sourcesSection{
  display:none !important;
  visibility:hidden !important;
}
</style>
</head>
<body>
  <div class="top-row">
    <h1>Infield Language Program Planning Tool</h1>
    <div class="notice-info" style="position:relative;">
      <span class="notice-line">Data stays on this device.</span>
      <button id="noticeBtn" aria-haspopup="dialog" aria-expanded="false" aria-controls="noticePop" title="More info">‚ìò</button>
      <div id="noticePop" class="notice-pop" role="dialog" aria-modal="false" aria-labelledby="noticeTitle">
        <strong id="noticeTitle">How your data is saved</strong>
        <p style="margin:.35rem 0 0;">
          Your data is saved only in your browser on this device. To avoid losing it,
          use the same browser and don‚Äôt clear your cache. Consider copying or writing down
          your language study plan each week as a backup.
        </p>
      </div>
    </div>
  </div>

  <!-- Password Box -->
  <div id="password-screen">
    <h2>Please enter the password</h2>
    <input type="text" id="password-input" placeholder="Password" />
    <button id="password-submit">Enter</button>
    <p id="password-error" style="color:red; display:none;">Incorrect password</p>
  </div>

  <!-- Protected content -->
  <div id="protected-content" style="display:none;">
    <div class="controls">
      <div>
        <label for="week-select">Week</label><br/>
        <select id="week-select"></select>
      </div>
      <div>
        <label for="entry-date">Infield Entry Date</label><br/>
        <input type="date" id="entry-date"/>
      </div>
    </div>

    <div id="planWrapper" class="plan-wrapper">
      <div class="plan-title" id="planTitle"></div>
      <div class="plan-dates" id="planDates"></div>
      <div class="plan-grid">

        <div id="pmgBox" class="plan-box green-box">
          <div class="plan-header">
            <h4 style="text-align: left;"><em>Preach My Gospel</em> Chapter 7 Topics</h4>
            <button id="addPMG" class="add-open add-text" data-kind="pmg">
              <span class="icon" aria-hidden="true">+</span>
              <span class="label">Add Chapter 7 topics</span>
            </button>
          </div>
          <ul id="planPMG" class="plan-list"></ul>
        </div>

        <div id="skillBox" class="plan-box blue-box">
          <div class="plan-header">
            <h4>Short-Term Language Skills</h4>
            <button id="addSkill" class="add-open add-text" data-kind="skill">
              <span class="icon" aria-hidden="true">+</span>
              <span class="label">Add short-term goals</span>
            </button>
          </div>
          <ul id="planSkills" class="plan-list"></ul>
        </div>

        <div id="skillBoxLong" class="plan-box blue-box">
          <div class="plan-header">
            <h4>Long-Term Language Skills</h4>
            <button id="addSkillLong" class="add-open add-text" data-kind="skillLong">
              <span class="icon" aria-hidden="true">+</span>
              <span class="label">Add long-term goals</span>
            </button>
          </div>
          <ul id="planSkillsLong" class="plan-list"></ul>
        </div>

        <div id="evalBox" class="plan-box yellow-box">
          <h4>Evaluate Your Language Study</h4>
          <ul id="planEval" class="plan-list"></ul>
        </div>
      </div>

      <div class="plan-actions">
        <!-- Left: Previous Week -->
        <div class="actions-left">
          <button class="btn nav-btn prev" id="prevWeek" aria-label="Previous Week">
            <span class="arrow" aria-hidden="true">‚Üê</span>
            <span class="label">Previous Week</span>
          </button>
        </div>

        <!-- Center: Clear Week ‚Ä¢ Copy Plan ‚Ä¢ Clear All -->
        <div class="actions-center">
          <button class="btn icon-btn" id="clearWeek">
            <span class="icon" aria-hidden="true">üßπ</span>
            <span class="label">Clear Week</span>
          </button>
          <button class="btn icon-btn" id="copyPlan">
            <span class="icon" aria-hidden="true">‚ßâ</span>
            <span class="label">Copy Plan</span>
          </button>
          <button class="btn icon-btn" id="clearAll">
            <span class="icon" aria-hidden="true">üóë</span>
            <span class="label">Clear All</span>
          </button>
        </div>

        <!-- Right: Next Week -->
        <div class="actions-right">
          <button class="btn nav-btn next" id="nextWeek" aria-label="Next Week">
            <span class="label">Next Week</span>
            <span class="arrow" aria-hidden="true">‚Üí</span>
          </button>
        </div>
      </div>
    </div>

    <!-- START: Source Section (hidden; used by modal only) -->
    <div id="sourcesSection" style="display:none" aria-hidden="true">
      <hr />
      <h2>Study Topic Options</h2>

      <!-- PMG -->
      <h3>Preach My Gospel Study</h3>
      <div id="pmgSource"></div>

      <!-- Language -->
      <h3>Language Tasks and Skills</h3>
      <div class="accordion-controls">
        <button class="btn" id="expandAllLanguage">Expand all</button>
        <button class="btn" id="collapseAllLanguage">Collapse all</button>
      </div>
      <div id="languageSource"></div>
    </div>
    <!-- END: Source Section -->
  </div> <!-- END: protected-content -->

  <div class="footer-bar">
    <footer>The code and functionality of this page were created using AI.</footer>
  </div>

<script>
/* =========================================================
 Password Protection
========================================================= */
(function () {
  const STORAGE_KEY = 'infield_unlock_v1';
  const CORRECT_PASSWORD = 'infield-26';

  const passwordScreen   = document.getElementById('password-screen');
  const protectedContent = document.getElementById('protected-content');
  const passwordError    = document.getElementById('password-error');
  const passwordInput    = document.getElementById('password-input');
  const submitBtn        = document.getElementById('password-submit');

  function showLockedUI() {
    if (passwordScreen)   passwordScreen.style.display = 'flex';
    if (protectedContent) protectedContent.style.display = 'none';
  }
  function showUnlockedUI() {
    if (passwordScreen)   passwordScreen.style.display = 'none';
    if (protectedContent) protectedContent.style.display = 'block';
    if (passwordError)    passwordError.style.display = 'none';
    if (passwordInput)    passwordInput.value = '';
  }

  (function applyInitialLockState() {
    let unlocked = false;
    try { unlocked = localStorage.getItem(STORAGE_KEY) === 'true'; } catch (e) {}
    if (unlocked) showUnlockedUI(); else showLockedUI();
  })();

  function unlock() {
    try { localStorage.setItem(STORAGE_KEY, 'true'); } catch (e) {}
    showUnlockedUI();
  }
  function tryUnlock() {
    const pw = (passwordInput?.value ?? '').trim();
    if (pw === CORRECT_PASSWORD) unlock();
    else {
      if (passwordError) passwordError.style.display = 'block';
      passwordInput?.focus(); passwordInput?.select();
    }
  }
  submitBtn?.addEventListener('click', tryUnlock);
  passwordInput?.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryUnlock(); });

  window.lockContent = function () {
    try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
    showLockedUI(); setTimeout(() => passwordInput?.focus(), 50);
  };
})();

/* =========================================================
 CONTENT MAPS ‚Äî EDIT THESE ONLY
========================================================= */
// PMG Topics (green box source)
const PMG_TOPICS = [
  { id: "pmg1", title: "Prepare Yourself Spiritually", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title3-p7#title3" },
  { id: "pmg2", title: "Be Dedicated and Diligent", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title4-p14#title4" },
  { id: "pmg3", title: "Principles of Language Learning", link: "https://www.churchofjesusch.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title6-p21#title6" },
  { id: "pmg4", title: "Create a Language Study Plan", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title12-p35#title12" },
  { id: "pmg5", title: "Learn with Your Companions", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title14-figure4_p3#title14" },
  { id: "pmg6", title: "Culture and Language Learning", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title16-figure5_p2#title16" },
  { id: "pmg7", title: "The Gift of Tongues", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title18-figure6_p6#title18" },
  { id: "pmg8", title: "Ideas for Study and Application: Personal Study", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=title19-aside2_p2#title19" },
  { id: "pmg9", title: "Ideas for Study and Application: Companion Study and Companion Exchange", link: "https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=aside2_title3-aside2_p7#aside2_title3" }
];
// Language sections (blue) ‚Äî short-term (numbered in plan)
const LANGUAGE_SECTIONS = [
  { id:"lesson1", title:"Lesson 1: The Message of the Restoration", items:[ { id:"item1", title:"Lesson 1: The Message of the Restoration", link:"#"} ] },
  { id:"lesson2", title:"Lesson 2: Heavenly Father‚Äôs Plan of Salvation", items:[ { id:"item2", title:"Lesson 2: Heavenly Father‚Äôs Plan of Salvation", link:"#"} ] },
  { id:"lesson3", title:"Lesson 3: The Gospel of Jesus Christ", items:[ { id:"item3", title:"Lesson 3: The Gospel of Jesus Christ", link:"#"} ] },
  { id:"pray-faith", title:"Pray with Faith in Jesus Christ",
    items:[
      { id:"item4",  title:"‚ÄúPray for those you are teaching.‚Äù (105)", link:"#"},
      { id:"item5",  title:"‚ÄúPray simply and sincerely that God will bless the people you are teaching‚Äù (181)", link:"#"},
      { id:"item6",  title:"‚ÄúAs needed, teach the person how to pray‚Äù (72)", link:"#"}
    ]},
  { id:"talk-everyone", title:"Talk with Everyone",
    items:[
      { id:"item7",  title:"‚ÄúAsk a question and listen to their response‚Äù (166)", link:"#"},
      { id:"item8",  title:"‚ÄúAsk about their families. Help them see how the restored gospel can bless their families.‚Äù (166)", link:"#"},
      { id:"item9",  title:"‚ÄúShare with them your purpose as a missionary and why you decided to serve a mission.‚Äù (166)", link:"#"}
    ]},
  { id:"unite-members", title:"Unite with Members",
    items:[
      { id:"item10", title:"‚ÄúBuild Strong Relationships with Local Leaders‚Äù (167)", link:"#"},
      { id:"item11", title:"‚ÄúSupport Members in Their Efforts to Share the Gospel‚Äù (168)", link:"#"},
      { id:"item12", title:"‚ÄúPromise Blessings for Sharing the Gospel‚Äù (169)", link:"#"}
    ]},
  { id:"find-people", title:"Find People Where They Are",
    items:[
      { id:"item13", title:"‚ÄúFind out what is most important to them‚Äù (171)", link:"#"},
      { id:"item14", title:"Seek to understand others‚Äô interests (171)", link:"#"},
      { id:"item15", title:"Discuss challenges people face (171)", link:"#"}
    ]},
  { id:"invite-spirit", title:"Invite the Spirit as You Begin Teaching",
    items:[
      { id:"item16", title:"‚ÄúAsk a few simple questions to help you understand their background and their expectations‚Äù (181)", link:"#"},
      { id:"item17", title:"‚ÄúExplain that you would like to begin and end each lesson with prayer.‚Äù (181)", link:"#"},
      { id:"item18", title:"‚ÄúGive a simple overview of what you will teach.‚Äù (182)", link:"#"}
    ]},
  { id:"use-scriptures", title:"Use the Scriptures",
    items:[
      { id:"item19", title:"‚ÄúIntroduce the Scripture‚Äù (183)", link:"#"},
      { id:"item20", title:"‚ÄúApply the Scriptures‚Äù (183)", link:"#"},
      { id:"item21", title:"‚ÄúInvite and Help People to Read on Their Own‚Äù (183)", link:"#"}
    ]},
  { id:"share-testimony-1", title:"Share Your Testimony (Part 1)",
    items:[
      { id:"item22", title:"‚ÄúShare a brief experience about how you gained this testimony.‚Äù (185)", link:"#"},
      { id:"item23", title:"‚ÄúWhen your companion is teaching, share your testimony to provide a second witness‚Äù (185)", link:"#"},
      { id:"item24", title:"‚ÄúShare your testimony that the principle you are teaching will bless the person‚Äôs life if he or she will follow it.‚Äù (185)", link:"#"}
    ]},
  { id:"teach-understanding", title:"Teach for Understanding",
    items:[
      { id:"item25", title:"‚ÄúAsk questions to help people think about what you have taught.‚Äù (189)", link:"#"},
      { id:"item26", title:"‚ÄúExplain words, phrases, and ideas.‚Äù (189)", link:"#"},
      { id:"item27", title:"‚ÄúKeep your teaching simple and brief.‚Äù (189)", link:"#"}
    ]},
  { id:"ask-questions", title:"Ask Questions",
    items:[
      { id:"item28", title:"‚ÄúAsk questions that help people feel the Spirit.‚Äù (190)", link:"#"},
      { id:"item29", title:"‚ÄúAsk questions that help you know how well people understand what you are teaching.‚Äù (190)", link:"#"},
      { id:"item30", title:"‚ÄúAsk questions that help people apply what they learn.‚Äù (191)", link:"#"}
    ]},
  { id:"extend-invitations", title:"Extend Invitations",
    items:[
      { id:"item31", title:"‚ÄúInvite with kind and clear language:‚Äù Church (203)", link:"#"},
      { id:"item32", title:"‚ÄúInvite with kind and clear language:‚Äù Baptism (203)", link:"#"},
      { id:"item33", title:"‚ÄúInvite with kind and clear language:‚Äù Read the scriptures (203)", link:"#"}
    ]},
  { id:"promise-blessings", title:"Promise People Blessings",
    items:[
      { id:"item34", title:"‚ÄúPrayerfully decide what blessings to promise each person as you extend invitations.‚Äù (204)", link:"#"},
      { id:"item35", title:"‚ÄúAssure [those you teach] that God will bless them as they strive to do His will.‚Äù (204)", link:"#"},
      { id:"item36", title:"‚ÄúHelp [those you teach] understand that opposition is an opportunity to grow by choosing to follow Christ even when it is difficult‚Äù (204)", link:"#"}
    ]},
  { id:"share-testimony-2", title:"Share Your Testimony (Part 2)",
    items:[
      { id:"item37", title:"‚ÄúShare your testimony whenever you extend an invitation and promise blessings.‚Äù (205)", link:"#"},
      { id:"item38", title:"‚ÄúTell how you have been blessed as you have lived the principle you are teaching.‚Äù (205)", link:"#"},
      { id:"item39", title:"‚ÄúShare your testimony that the principle will bless the person‚Äôs life as he or she lives it.‚Äù (205)", link:"#"}
    ]},
  { id:"keep-commitments", title:"Help People Keep Their Commitments",
    items:[
      { id:"item40", title:"‚ÄúEncourage and Help People in Your Daily Contact‚Äù (206)", link:"#"},
      { id:"item41", title:"‚ÄúHave the Influence of the Holy Ghost in Your Daily Contact‚Äù (206)", link:"#"},
      { id:"item42", title:"‚ÄúShow Love‚Äù (207)", link:"#"}
    ]},
  { id:"schedule-appointments", title:"Schedule Appointments", items:[ { id:"item43", title:"Schedule Appointments", link:"#"} ] },
  { id:"talk-food",           title:"Talk about Food",          items:[ { id:"item44", title:"Talk about Food", link:"#"} ] },
  { id:"talk-health",         title:"Talk about Health",        items:[ { id:"item45", title:"Talk about Health", link:"#"} ] },
  { id:"transportation",      title:"Transportation",           items:[ { id:"item46", title:"Transportation", link:"#"} ] },
  { id:"daily-life",          title:"Daily Life Topic of Choice",items:[ { id:"item47", title:"Daily Life Topic of Choice", link:"#"} ] }
];
// Long-term Language sections ‚Äî unnumbered in plan
const LANGUAGE_SECTIONS_LONG = [
  { id:"lt-habits", title:"Long-Term Habits & Routines",
    items:[
      { id:"lt1", title:"Sustain a daily native-input habit (podcast/news)", link:"#"},
      { id:"lt2", title:"Weekly deep-dive grammar review plan",               link:"#"},
      { id:"lt3", title:"Pronunciation refinement routine",                   link:"#"}
    ]},
  { id:"lt-milestones", title:"Long-Term Milestones",
    items:[
      { id:"lt4", title:"Prepare and deliver a 10-minute talk (native outline)", link:"#"},
      { id:"lt5", title:"30-day scripture reading challenge (summaries in target language)", link:"#"}
    ]},
  { id:"lt-projects", title:"Projects & Portfolios",
    items:[
      { id:"lt6", title:"Personal glossary & example sentences (living document)", link:"#"},
      { id:"lt7", title:"Record monthly self-assessments and reflections",        link:"#"}
    ]}
];

/* =========================================================
 STORAGE KEYS & HELPERS
========================================================= */
const WEEK_COUNT = 12;
const getFavKeyPMG       = (w)=> `plan_pmg_week_${w}`;
const getFavKeySkill     = (w)=> `plan_skills_week_${w}`;
const getFavKeySkillLong = (w)=> `plan_skills_long_week_${w}`;
const getWeekStateKey    = (w)=> `completion_week_${w}`;
const EVAL_KEY           = (w)=> `evaluation_week_${w}`;
const COUNTS_KEY         = "completionCounts";
const CUSTOM_SHORT_KEY   = 'custom_short_goals';
const CUSTOM_LONG_KEY    = 'custom_long_goals';

const readArr   = (key)=> JSON.parse(localStorage.getItem(key) ?? "[]");
const writeArr  = (key, arr)=> localStorage.setItem(key, JSON.stringify(arr));
function getCustomLib(kind){ return kind === 'skill' ? readArr(CUSTOM_SHORT_KEY) : readArr(CUSTOM_LONG_KEY); }
function setCustomLib(kind, arr){ if (kind === 'skill') writeArr(CUSTOM_SHORT_KEY, arr); else writeArr(CUSTOM_LONG_KEY, arr); }

const readSet   = (key)=> new Set(JSON.parse(localStorage.getItem(key) ?? "[]"));
const writeSet  = (key, s)=> localStorage.setItem(key, JSON.stringify(Array.from(s)));
const readObj   = (key)=> JSON.parse(localStorage.getItem(key) ?? "{}");
const writeObj  = (key, o)=> localStorage.setItem(key, JSON.stringify(o));
const readCounts= ()=> JSON.parse(localStorage.getItem(COUNTS_KEY) ?? "{}");
const writeCounts= (o)=> localStorage.setItem(COUNTS_KEY, JSON.stringify(o));
const getCount  = (id)=> (readCounts()[id] ?? 0);
function incCount(id){ const c=readCounts(); c[id]=(c[id]??0)+1; writeCounts(c); updateCompletionDisplays(id); }
function decCount(id){ const c=readCounts(); c[id]=Math.max(0,(c[id]??0)-1); writeCounts(c); updateCompletionDisplays(id); }

/* =========================================================
 DATE / WEEK LOGIC
========================================================= */
const weekSelect = document.getElementById("week-select");
let activeWeek = parseInt(localStorage.getItem("activeWeek") ?? "1",10);
if (isNaN(activeWeek) || activeWeek < 1 || activeWeek > WEEK_COUNT) activeWeek = 1;
for (let i=1;i<=WEEK_COUNT;i++){
  const opt = document.createElement("option");
  opt.value = String(i); opt.textContent = `Week ${i}`;
  weekSelect.appendChild(opt);
}
weekSelect.value = String(activeWeek);
weekSelect.addEventListener("change", ()=> setActiveWeek(parseInt(weekSelect.value,10)));

const entryDateEl = document.getElementById("entry-date");
(function initEntryDate(){
  const saved = localStorage.getItem("infieldEntryDate");
  const today = new Date();
  entryDateEl.value = saved ?? toInput(today);
  localStorage.setItem("infieldEntryDate", entryDateEl.value);
  entryDateEl.addEventListener("change", ()=>{
    if (entryDateEl.value){
      localStorage.setItem("infieldEntryDate", entryDateEl.value);
      updatePlanHeader();
    }
  });
})();
function toInput(d){ const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),da=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${da}`; }
function fromInput(s){ const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); }
function computeBaseMonday(entryDate){
  const day=entryDate.getDay(); const delta=(day===0? -6 : 1-day);
  const monday=new Date(entryDate); monday.setHours(0,0,0,0); monday.setDate(entryDate.getDate()+delta);
  return monday;
}
function weekStartEnd(weekNumber){
  const entryVal = localStorage.getItem("infieldEntryDate");
  const entryDate = entryVal ? fromInput(entryVal) : new Date();
  const baseMonday = computeBaseMonday(entryDate);
  const start = new Date(baseMonday); start.setDate(baseMonday.getDate()+7*(weekNumber-1));
  const end   = new Date(start);      end.setDate(start.getDate()+6);
  return { start, end };
}
const WD=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const MO=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
function fmtFull(d){ return `${WD[d.getDay()]} ${MO[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`; }

/* =========================================================
 NUMBERING
========================================================= */
function buildNumberingMaps(){
  const sectionNum = new Map();
  const itemNum    = new Map();
  LANGUAGE_SECTIONS.forEach((sec,si)=>{
    const sNo = si+1; sectionNum.set(sec.id, sNo);
    sec.items.forEach((it,ii)=> itemNum.set(it.id, { sec:sNo, idx: ii+1 }) );
  });
  return { sectionNum, itemNum };
}

/* =========================================================
 RENDER: SOURCE LISTS (PMG & LANGUAGE) ‚Äî for parity and counts (kept hidden)
========================================================= */
const pmgSource      = document.getElementById("pmgSource");
const languageSource = document.getElementById("languageSource");

function renderSources(){
  // PMG
  pmgSource.innerHTML = "";
  const pmgSection = document.createElement("div");
  pmgSection.className = "section collapsed";
  pmgSection.dataset.sectionId = "pmg-ch7";
  const pmgHeader = document.createElement("div");
  pmgHeader.className = "section-header";
  pmgHeader.innerHTML = `<span class="arrow">‚ñ∂</span><span>Chapter 7 Topics</span>`;
  pmgHeader.addEventListener("click", ()=> pmgSection.classList.toggle("collapsed"));
  pmgSection.appendChild(pmgHeader);
  const pmgList = document.createElement("ul");
  pmgList.className = "section-items source-list";
  PMG_TOPICS.forEach(t=> pmgList.appendChild(buildSourceLi({id:t.id,title:t.title,link:t.link}, "pmg")));
  pmgSection.appendChild(pmgList);
  pmgSource.appendChild(pmgSection);

  // Language (short-term)
  languageSource.innerHTML = "";
  const { sectionNum } = buildNumberingMaps();
  LANGUAGE_SECTIONS.forEach(sec=>{
    const sWrap = document.createElement("div");
    sWrap.className = "section collapsed";
    sWrap.dataset.sectionId = sec.id;

    const header = document.createElement("div");
    header.className = "section-header";
    header.innerHTML = `<span class="arrow">‚ñ∂</span><span>${sectionNum.get(sec.id)}. ${sec.title}</span>`;
    header.addEventListener("click", ()=> sWrap.classList.toggle("collapsed"));
    sWrap.appendChild(header);

    const items = document.createElement("ul");
    items.className = "section-items source-list";
    sec.items.forEach((it, index)=>{
      const numberedTitle = `${sectionNum.get(sec.id)}.${index+1} ${it.title}`;
      items.appendChild(buildSourceLi({id:it.id,title:numberedTitle,link:it.link}, "skill"));
    });
    sWrap.appendChild(items);
    languageSource.appendChild(sWrap);
  });

  refreshAddButtons();
  refreshAllCompletionDisplays();
}

function buildSourceLi(item, kind){
  const li = document.createElement("li");
  li.dataset.itemId = item.id;

  const card = document.createElement("div"); card.className="card";
  const top  = document.createElement("div"); top.className="card-row top";

  const actionsLeft = document.createElement("div"); actionsLeft.className="card-actions-left";
  const btn  = document.createElement("button"); btn.className="add-btn"; btn.textContent="+";
  actionsLeft.appendChild(btn);

  const title = document.createElement("div"); title.className="card-title";
  const titleText = document.createElement("span"); titleText.className="card-title-text"; titleText.textContent=item.title;
  title.appendChild(titleText);

  top.appendChild(actionsLeft);
  top.appendChild(title);
  card.appendChild(top);

  const line = document.createElement("div");
  line.className = "completion-line";
  line.dataset.compId = item.id;
  (function initSourceLine(){ const count = getCount(item.id); line.textContent = count > 0 ? `Completed ${count} ${count===1 ? "time" : "times"}` : ""; })();
  card.appendChild(line);

  btn.addEventListener("click", (e)=>{
    e.stopPropagation();
    if (btn.disabled) return;
    if (kind === "pmg")       addPMGToPlan(item);
    else if (kind === "skill")     addSkillToPlan(item);
    else if (kind === "skillLong") addSkillLongToPlan(item);
  });

  li.appendChild(card);
  return li;
}

/* =========================================================
 PLAN RENDER & ACTIONS
========================================================= */
const planPMG        = document.getElementById("planPMG");
const planSkills     = document.getElementById("planSkills");
const planSkillsLong = document.getElementById("planSkillsLong");
const planEval       = document.getElementById("planEval");

function refreshNavButtons(){
  const prevBtn = document.getElementById("prevWeek");
  const nextBtn = document.getElementById("nextWeek");
  if (!prevBtn || !nextBtn) return;
  prevBtn.disabled = activeWeek <= 1;
  nextBtn.disabled = activeWeek >= WEEK_COUNT;
  prevBtn.title = prevBtn.disabled ? "You are on Week 1" : "";
  nextBtn.title = nextBtn.disabled ? "You are on Week 12" : "";
}
function updatePlanHeader(){
  const { start, end } = weekStartEnd(activeWeek);
  document.getElementById("planTitle").textContent = `Week ${activeWeek} Language Study Plan`;
  document.getElementById("planDates").textContent = `${fmtFull(start)} ‚Äì ${fmtFull(end)}`;
}
function renderPlan(){
  updatePlanHeader();

  // PMG (single)
  planPMG.innerHTML = "";
  const pmgSet = readSet(getFavKeyPMG(activeWeek));
  const chosenId = pmgSet.values().next().value;
  if (chosenId){
    const topic = PMG_TOPICS.find(t=>t.id===chosenId);
    if (topic) planPMG.appendChild(buildPlanLi(topic, "pmg", null));
  }

  // Short-term Skills (numbered)
  planSkills.innerHTML = "";
  const skillSet = readSet(getFavKeySkill(activeWeek));
  const { itemNum } = buildNumberingMaps();
  Array.from(skillSet).forEach(id=>{
    const item = findItemById(id);
    if (item){
      const numObj = itemNum.get(item.id);
      const displayNum = numObj ? `${numObj.sec}.${numObj.idx}` : null;
      planSkills.appendChild(buildPlanLi(item, "skill", displayNum));
    }
  });

  // Long-term Skills (unnumbered)
  planSkillsLong.innerHTML = "";
  const skillLongSet = readSet(getFavKeySkillLong(activeWeek));
  Array.from(skillLongSet).forEach(id=>{
    const item = findItemById(id);
    if (item){
      planSkillsLong.appendChild(buildPlanLi(item, "skillLong", null));
    }
  });

  // Evaluation
  planEval.innerHTML = "";
  planEval.appendChild(buildEvalLi());

  refreshAddButtons();
  refreshAddOpenButtons();
}
function findItemById(id){
  for (const sec of LANGUAGE_SECTIONS){
    const found = sec.items.find(i=>i.id===id);
    if (found) return found;
  }
  for (const sec of LANGUAGE_SECTIONS_LONG){
    const found = sec.items.find(i=>i.id===id);
    if (found) return found;
  }
  // custom libraries
  const cShort = readArr(CUSTOM_SHORT_KEY).find(i => i.id === id);
  if (cShort) return { id: cShort.id, title: cShort.title, link: "#" };
  const cLong  = readArr(CUSTOM_LONG_KEY).find(i => i.id === id);
  if (cLong)  return { id: cLong.id, title: cLong.title, link: "#" };
  return null;
}
function buildPlanLi(item, kind, displayNum){
  const li = document.createElement("li");
  li.dataset.planId = item.id;

  const card = document.createElement("div"); card.className="card in-plan";
  const top  = document.createElement("div"); top.className="card-row top";

  const actionsLeft = document.createElement("div"); actionsLeft.className="card-actions-left";
  const remove = document.createElement("button"); remove.className="remove-btn"; remove.title="Remove"; remove.textContent="‚Äì";
  actionsLeft.appendChild(remove);

  const circle = document.createElement("button");
  circle.className = "circle-check";
  circle.setAttribute("role","checkbox");
  circle.setAttribute("aria-checked","false");
  circle.setAttribute("title","Mark completed");
  circle.innerHTML = '<span class="mark">‚úì</span>';

  const title = document.createElement("div"); title.className="card-title";
  const numSpan = document.createElement("span"); numSpan.className="card-num";
  if (displayNum) numSpan.textContent = displayNum; else numSpan.style.display = "none";
  const titleText = document.createElement("span"); titleText.className="card-title-text"; titleText.textContent = item.title;
  title.appendChild(numSpan); title.appendChild(titleText);

  const right = document.createElement("div"); right.className="right-actions";
  const linkA = document.createElement("a");
  linkA.className="ext-link"; linkA.textContent="‚Üó"; linkA.href=item.link||"#"; linkA.target="_blank"; linkA.rel="noopener noreferrer";
  linkA.dataset.linkId=item.id;
  const moveNext = document.createElement("button"); moveNext.className="move-next"; moveNext.title="Move or repeat to next week";
  right.appendChild(linkA); right.appendChild(moveNext);

  top.appendChild(actionsLeft);
  top.appendChild(circle);
  top.appendChild(title);
  top.appendChild(right);
  card.appendChild(top);

  const line = document.createElement("div"); line.className="completion-line"; line.dataset.compId = item.id; card.appendChild(line);

  const wkState = readObj(getWeekStateKey(activeWeek));
  let isChecked = !!wkState[item.id];
  applyCheckUI(isChecked, circle, card, line, item.id);
  remove.disabled = isChecked;

  circle.addEventListener("click", ()=>toggleCheck(item.id));
  circle.addEventListener("keydown",(e)=>{ if(e.key===" "||e.key==="Enter"){ e.preventDefault(); toggleCheck(item.id); } });

  function toggleCheck(id){
    const state = readObj(getWeekStateKey(activeWeek));
    const now = !state[id];
    state[id] = now; writeObj(getWeekStateKey(activeWeek), state);
    if (now) incCount(id); else decCount(id);
    isChecked = now;
    applyCheckUI(isChecked, circle, card, line, id);
    remove.disabled = isChecked;
    refreshMoveNextButton(moveNext, item, kind, isChecked);
  }

  remove.addEventListener("click", () => {
    if (isChecked) { showToast("Uncheck the item before removing it"); return; }
    if (kind === "pmg") {
      const set = readSet(getFavKeyPMG(activeWeek)); set.clear(); writeSet(getFavKeyPMG(activeWeek), set);
    } else if (kind === "skill") {
      const set = readSet(getFavKeySkill(activeWeek)); set.delete(item.id); writeSet(getFavKeySkill(activeWeek), set);
    } else if (kind === "skillLong") {
      const set = readSet(getFavKeySkillLong(activeWeek)); set.delete(item.id); writeSet(getFavKeySkillLong(activeWeek), set);
    }
    refreshUI();
  });

  refreshMoveNextButton(moveNext, item, kind, isChecked);
  moveNext.addEventListener("click", ()=> handleMoveNext(item, kind, isChecked));

  li.appendChild(card);
  return li;
}
function applyCheckUI(isChecked, circleBtn, card, lineEl, itemId){
  circleBtn.setAttribute("aria-checked", isChecked ? "true" : "false");
  card.classList.toggle("completed", isChecked);
  const count = getCount(itemId);
  lineEl.textContent = count>0 ? `Completed ${count} ${count===1 ? "time" : "times"}` : "";
}
function refreshMoveNextButton(btn, item, kind, isChecked){
  const nextWeek = activeWeek + 1;
  if (nextWeek > WEEK_COUNT){
    btn.disabled = true;
    btn.classList.toggle("is-repeat", isChecked);
    btn.textContent = isChecked ? "‚ü≥" : "‚Üí";
    btn.title = "You are on Week 12. There is no next week.";
    return;
  }
  let alreadyThere = false;
  if (kind === "pmg"){
    const nset = readSet(getFavKeyPMG(nextWeek));
    const chosen = nset.values().next().value;
    alreadyThere = (chosen === item.id);
  } else if (kind === "skill") {
    const nset = readSet(getFavKeySkill(nextWeek)); alreadyThere = nset.has(item.id);
  } else if (kind === "skillLong") {
    const nset = readSet(getFavKeySkillLong(nextWeek)); alreadyThere = nset.has(item.id);
  }
  btn.textContent = isChecked ? "‚ü≥" : "‚Üí";
  btn.classList.toggle("is-repeat", isChecked);
  btn.disabled = alreadyThere;
  btn.title = alreadyThere ? "Already in next week's plan." : (isChecked ? "Repeat in next week" : "Move to next week");
}
async function handleMoveNext(item, kind, isChecked){
  const nextWeek = activeWeek + 1; if (nextWeek > WEEK_COUNT) return;
  if (kind === "pmg"){
    const nset = readSet(getFavKeyPMG(nextWeek));
    const currentNext = nset.values().next().value ?? null;
    if (currentNext && currentNext !== item.id){
      const ok = await appConfirm(`Next week already has a PMG topic. Replace it with "${item.title}"?`, "Replace PMG for next week");
      if (!ok) return; nset.clear();
    }
    nset.add(item.id); writeSet(getFavKeyPMG(nextWeek), nset);
    if (!isChecked){
      const cset = readSet(getFavKeyPMG(activeWeek)); cset.clear(); writeSet(getFavKeyPMG(activeWeek), cset);
      const state = readObj(getWeekStateKey(activeWeek)); Object.keys(state).forEach(k=>{ if(k===item.id) state[k]=false; }); writeObj(getWeekStateKey(activeWeek), state);
    }
    const nstate = readObj(getWeekStateKey(nextWeek)); nstate[item.id] = false; writeObj(getWeekStateKey(nextWeek), nstate);
  } else if (kind === "skill") {
    const nset = readSet(getFavKeySkill(nextWeek)); if (!nset.has(item.id)) nset.add(item.id); writeSet(getFavKeySkill(nextWeek), nset);
    if (!isChecked){
      const cset = readSet(getFavKeySkill(activeWeek)); cset.delete(item.id); writeSet(getFavKeySkill(activeWeek), cset);
      const state = readObj(getWeekStateKey(activeWeek)); state[item.id] = false; writeObj(getWeekStateKey(activeWeek), state);
    }
    const nstate = readObj(getWeekStateKey(nextWeek)); nstate[item.id] = false; writeObj(getWeekStateKey(nextWeek), nstate);
  } else if (kind === "skillLong") {
    const nset = readSet(getFavKeySkillLong(nextWeek)); if (!nset.has(item.id)) nset.add(item.id); writeSet(getFavKeySkillLong(nextWeek), nset);
    if (!isChecked){
      const cset = readSet(getFavKeySkillLong(activeWeek)); cset.delete(item.id); writeSet(getFavKeySkillLong(activeWeek), cset);
      const state = readObj(getWeekStateKey(activeWeek)); state[item.id] = false; writeObj(getWeekStateKey(activeWeek), state);
    }
    const nstate = readObj(getWeekStateKey(nextWeek)); nstate[item.id] = false; writeObj(getWeekStateKey(nextWeek), nstate);
  }
  refreshUI();
}

/* ===== Evaluation special card ===== */
function buildEvalLi(){
  const li = document.createElement("li");
  const card = document.createElement("div"); card.className="card in-plan";
  const top = document.createElement("div"); top.className="card-row top";
  const circle = document.createElement("button");
  circle.className = "circle-check";
  circle.setAttribute("role","checkbox");
  circle.setAttribute("aria-checked","false");
  circle.setAttribute("title","Mark completed");
  circle.innerHTML = '<span class="mark">‚úì</span>';
  const title = document.createElement("div"); title.className="card-title";
  const numSpan = document.createElement("span"); numSpan.className="card-num"; numSpan.style.display="none";
  const titleText = document.createElement("span"); titleText.className="card-title-text"; titleText.textContent="Complete a Language Study Evaluation";
  title.appendChild(numSpan); title.appendChild(titleText);
  const right = document.createElement("div"); right.className="right-actions";
  const a = document.createElement("a"); a.className="ext-link"; a.textContent="‚Üó"; a.href="https://www.churchofjesuschrist.org/study/manual/preach-my-gospel-2023/15-chapter-7?lang=eng&id=figure2_title1-figure2_p8#figure2_title1"; a.target="_blank"; a.rel="noopener noreferrer"; a.dataset.linkId="evaluation";
  right.appendChild(a);
  top.appendChild(circle); top.appendChild(title); top.appendChild(right);
  card.appendChild(top);
  const line = document.createElement("div"); line.className="completion-line"; card.appendChild(line);
  let isOn = localStorage.getItem(EVAL_KEY(activeWeek)) === "true";
  applyCheckUI(isOn, circle, card, line, "evaluation");
  circle.addEventListener("click", ()=>{
    isOn = !isOn; localStorage.setItem(EVAL_KEY(activeWeek), String(isOn));
    applyCheckUI(isOn, circle, card, line, "evaluation");
  });
  circle.addEventListener("keydown",(e)=>{ if(e.key===" "||e.key==="Enter"){ e.preventDefault(); circle.click(); }});
  li.appendChild(card);
  return li;
}

/* =========================================================
 ADD / DISABLE LOGIC FOR SOURCE BUTTONS
========================================================= */
function refreshAddButtons(){
  const pmgSet = readSet(getFavKeyPMG(activeWeek));
  const chosen = pmgSet.values().next().value ?? null;
  document.querySelectorAll('#pmgSource li[data-item-id]').forEach(li=>{
    const id  = li.dataset.itemId;
    const btn = li.querySelector('.add-btn');
    btn.disabled = (id === chosen);
  });
  const skillSet = readSet(getFavKeySkill(activeWeek));
  document.querySelectorAll('#languageSource li[data-item-id]').forEach(li=>{
    const id  = li.dataset.itemId;
    const btn = li.querySelector('.add-btn');
    btn.disabled = skillSet.has(id);
  });
}

/* =========================================================
 HIDDEN SECTION ACCORDION CONTROLS (for completeness)
========================================================= */
document.getElementById("expandAllLanguage")?.addEventListener("click", () => {
  document.querySelectorAll("#languageSource .section").forEach(sec => sec.classList.remove("collapsed"));
});
document.getElementById("collapseAllLanguage")?.addEventListener("click", () => {
  document.querySelectorAll("#languageSource .section").forEach(sec => sec.classList.add("collapsed"));
});

/* =========================================================
 ADD TO PLAN (from source)
========================================================= */
async function addPMGToPlan(topic){
  const set = readSet(getFavKeyPMG(activeWeek));
  if (set.size === 0){
    set.add(topic.id); writeSet(getFavKeyPMG(activeWeek), set);
    refreshUI();
    if (isPickerOpen()) refreshPickerAddButtons(getPickerContent(), 'pmg');
    return;
  }
  closePicker();
  const ok = await appConfirm(
    `You can only have one study focus in this section. Would you like to change it to "${topic.title}"?`,
    "Replace Study Focus"
  );
  if (!ok) return;
  set.clear(); set.add(topic.id); writeSet(getFavKeyPMG(activeWeek), set);
  const state = readObj(getWeekStateKey(activeWeek)); Object.keys(state).forEach(k => { if (k.startsWith("pmg")) state[k]=false; }); writeObj(getWeekStateKey(activeWeek), state);
  refreshUI();
  if (isPickerOpen()) refreshPickerAddButtons(getPickerContent(), 'pmg');
}
function addSkillToPlan(item){
  const set = readSet(getFavKeySkill(activeWeek));
  if (!set.has(item.id)){ set.add(item.id); writeSet(getFavKeySkill(activeWeek), set); refreshUI(); if (isPickerOpen()) refreshPickerAddButtons(getPickerContent(), 'skill'); }
}
function addSkillLongToPlan(item){
  const set = readSet(getFavKeySkillLong(activeWeek));
  if (!set.has(item.id)){ set.add(item.id); writeSet(getFavKeySkillLong(activeWeek), set); refreshUI(); if (isPickerOpen()) refreshPickerAddButtons(getPickerContent(), 'skillLong'); }
}

/* =========================================================
 COPY PLAN ‚Üí MARKDOWN
========================================================= */
document.getElementById("copyPlan").addEventListener("click", () => {
  const { start, end } = weekStartEnd(activeWeek);
  const planTitle = `## Week ${activeWeek} Language Study Plan`;
  const datesLine = `_${fmtFull(start)} ‚Äì ${fmtFull(end)}_`;
  const pmgSet = readSet(getFavKeyPMG(activeWeek));
  const pmgId = pmgSet.values().next().value;
  const pmgTopic = PMG_TOPICS.find(t => t.id === pmgId);

  const { itemNum } = buildNumberingMaps();
  const skillSet = readSet(getFavKeySkill(activeWeek));
  const skillsLines = Array.from(skillSet).map(id=>{
    const item = findItemById(id) ?? { title:id };
    const num  = itemNum.get(id);
    const t    = num ? `${num.sec}.${num.idx} ${item.title}` : item.title;
    return `- ${t}`;
  });

  const skillSetLong = readSet(getFavKeySkillLong(activeWeek));
  const skillsLongLines = Array.from(skillSetLong).map(id=>{
    const item = findItemById(id) ?? { title:id };
    return `- ${item.title}`; // unnumbered
  });

  const lines = [
    planTitle, datesLine, "",
    "### Preach My Gospel study section", ...(pmgTopic ? [`- ${pmgTopic.title}`] : []),
    "",
    "### Short-Term Language Skills", ...(skillsLines.length ? skillsLines : []),
    "",
    "### Long-Term Language Skills", ...(skillsLongLines.length ? skillsLongLines : []),
    "",
    "### Evaluate Your Language Study", "- Complete a Language Study Evaluation"
  ];
  const text = lines.join("\n");
  navigator.clipboard?.writeText(text)
    .then(()=> { showToast("Plan copied to clipboard"); })
    .catch(()=>{
      const ta = document.createElement("textarea");
      ta.value = text; document.body.appendChild(ta); ta.select();
      try { document.execCommand("copy"); showToast("Plan copied to clipboard"); }
      catch { showToast("Copy failed. You can select and copy manually."); }
      finally { document.body.removeChild(ta); }
    });
});

/* =========================================================
 CLEAR ACTIONS & NAV  (now clears LONG-TERM too)
========================================================= */
document.getElementById("clearWeek").addEventListener("click", async ()=>{
  const { start, end } = weekStartEnd(activeWeek);
  const msg =
`Clear Week ${activeWeek}?\n\n` +
`This will:\n` +
`‚Ä¢ Remove all items from this week‚Äôs plan\n` +
`‚Ä¢ Uncheck anything you marked ‚Äúcompleted‚Äù this week (including Evaluation)\n` +
`‚Ä¢ Reduce the ‚ÄúCompleted X times‚Äù total for items you checked this week by 1\n\n` +
`Week dates: ${fmtFull(start)} ‚Äì ${fmtFull(end)}\n\n` +
`This cannot be undone. Continue?`;
  const ok = await appConfirm(msg, "Clear Week");
  if (!ok) return;

  const state = readObj(getWeekStateKey(activeWeek));
  Object.entries(state).forEach(([itemId, isOn])=>{ if (isOn && itemId !== "evaluation") decCount(itemId); });

  // CLEAR PMG, SHORT-TERM, LONG-TERM
  writeSet(getFavKeyPMG(activeWeek),       new Set());
  writeSet(getFavKeySkill(activeWeek),     new Set());
  writeSet(getFavKeySkillLong(activeWeek), new Set());

  localStorage.removeItem(EVAL_KEY(activeWeek));
  localStorage.removeItem(getWeekStateKey(activeWeek));

  refreshUI();
  showToast(`Week ${activeWeek} cleared`);
});

document.getElementById("clearAll").addEventListener("click", async ()=>{
  const msg =
`Clear ALL weeks (Weeks 1‚Äì${WEEK_COUNT})?\n\n` +
`This will:\n` +
`‚Ä¢ Remove all items from every week‚Äôs plan\n` +
`‚Ä¢ Uncheck everything that was marked ‚Äúcompleted‚Äù in any week\n` +
`‚Ä¢ Reset every item‚Äôs ‚ÄúCompleted X times‚Äù total to 0\n\n` +
`This cannot be undone. Continue?`;
  const ok = await appConfirm(msg, "Clear All Weeks");
  if (!ok) return;

  for (let w=1; w<=WEEK_COUNT; w++){
    // CLEAR PMG, SHORT-TERM, LONG-TERM
    writeSet(getFavKeyPMG(w),       new Set());
    writeSet(getFavKeySkill(w),     new Set());
    writeSet(getFavKeySkillLong(w), new Set());

    localStorage.removeItem(EVAL_KEY(w));
    localStorage.removeItem(getWeekStateKey(w));
  }
  localStorage.removeItem(COUNTS_KEY);
  refreshUI();
  showToast("All weeks cleared");
});

document.getElementById("nextWeek").addEventListener("click", () => {
  if (activeWeek >= WEEK_COUNT) return;
  setActiveWeek(activeWeek + 1);
  window.scrollTo({ top: 0, behavior: "smooth" });
});
document.getElementById("prevWeek").addEventListener("click", () => {
  if (activeWeek <= 1) return;
  setActiveWeek(activeWeek - 1);
  window.scrollTo({ top: 0, behavior: "smooth" });
});

/* =========================================================
 COMPLETION LINE REFRESH
========================================================= */
function updateCompletionDisplays(itemId){
  const count = getCount(itemId);
  document.querySelectorAll(`.completion-line[data-comp-id="${itemId}"]`).forEach(el=>{
    el.textContent = count>0 ? `Completed ${count} ${count===1?"time":"times"}` : "";
  });
}

/* =========================================================
 INFO POPOVER
========================================================= */
const noticeBtn = document.getElementById("noticeBtn");
const noticePop = document.getElementById("noticePop");
document.addEventListener("click", (e)=>{
  if (noticeBtn.contains(e.target)){
    const open = noticePop.classList.toggle("show");
    noticeBtn.setAttribute("aria-expanded", open?"true":"false");
    if (open) {
      const rect = noticeBtn.getBoundingClientRect();
      const popWidth = noticePop.offsetWidth;
      let left = rect.left + rect.width/2 - popWidth/2;
      left = Math.max(8, Math.min(left, window.innerWidth - popWidth - 8));
      noticePop.style.top = `${rect.bottom + 8}px`;
      noticePop.style.left = `${left}px`;
    }
    return;
  }
  if (!noticePop.contains(e.target)){
    noticePop.classList.remove("show");
    noticeBtn.setAttribute("aria-expanded","false");
  }
});

/* ===== Custom alert/confirm helpers ===== */
function appAlert(message, {title} = {}){
  return new Promise(resolve => { openAppModal({ message, title, mode: 'alert', onOk: () => resolve() }); });
}
function appConfirm(message, title = "Confirm"){
  return new Promise(resolve => { openAppModal({ message, title, mode: 'confirm', onOk: () => resolve(true), onCancel: () => resolve(false) }); });
}
function openAppModal({ message, title, mode, onOk, onCancel }){
  const modal = document.getElementById('appModal');
  const msgEl = document.getElementById('appModalMessage');
  const titleEl = modal.querySelector('.app-modal__title');
  const btnOk = document.getElementById('appModalOk');
  const btnCancel = document.getElementById('appModalCancel');
  const btnClose = modal.querySelector('.app-modal__close');
  const backdrop = modal.querySelector('.app-modal__backdrop');
  if (title) titleEl.textContent = title;
  msgEl.textContent = message;
  btnCancel.style.display = (mode === 'confirm') ? 'inline-block' : 'none';
  modal.setAttribute('aria-hidden', 'false');
  setTimeout(() => btnOk.focus(), 0);
  const cleanup = () => {
    modal.setAttribute('aria-hidden', 'true');
    btnOk.replaceWith(btnOk.cloneNode(true));
    btnCancel.replaceWith(btnCancel.cloneNode(true));
    btnClose.replaceWith(btnClose.cloneNode(true));
    backdrop.replaceWith(backdrop.cloneNode(true));
  };
  const wire = () => {
    const ok = document.getElementById('appModalOk');
    const cancel = document.getElementById('appModalCancel');
    const close = modal.querySelector('.app-modal__close');
    const back = modal.querySelector('.app-modal__backdrop');
    ok.addEventListener('click', () => { cleanup(); onOk && onOk(); });
    cancel.addEventListener('click', () => { cleanup(); onCancel && onCancel(); });
    close.addEventListener('click', () => { cleanup(); (onCancel ?? onOk)?.(); });
    back.addEventListener('click', () => { cleanup(); (onCancel ?? onOk)?.(); });
    modal.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { e.preventDefault(); cleanup(); (onCancel ?? onOk)?.(); }
    });
  };
  wire();
}

/* ===== Toast ===== */
let toastTimer = null;
function showToast(message, timeout = 2000){
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { toast.classList.remove("show"); }, timeout);
}

/* ===== Refresh all source completion lines after rendering ===== */
function refreshAllCompletionDisplays(){ PMG_TOPICS.forEach(t => updateCompletionDisplays(t.id)); LANGUAGE_SECTIONS.forEach(sec => { sec.items.forEach(it => updateCompletionDisplays(it.id)); }); }

/* =========================================================
 CUSTOM GOALS (library + section render)
========================================================= */
function renderCustomGoalsSection(container, kind){
  const isShort = (kind === 'skill');
  const lib = getCustomLib(kind);

  const sWrap = document.createElement('div');
  sWrap.className = 'section'; // open by default (not collapsed)
  sWrap.dataset.sectionId = isShort ? 'custom-short' : 'custom-long';

  const header = document.createElement('div');
  header.className = 'section-header';
  const headerTitle = isShort ? 'My short-term goals' : 'My long-term goals';
  header.innerHTML = `<span class="arrow">‚ñ∂</span><span>${headerTitle}</span>`;
  header.addEventListener('click', () => sWrap.classList.toggle('collapsed'));
  sWrap.appendChild(header);

  const items = document.createElement('ul');
  items.className = 'section-items source-list';
  lib.forEach(it => {
    items.appendChild(buildSourceLi({ id: it.id, title: it.title, link: "#" }, kind));
  });
  sWrap.appendChild(items);

  container.appendChild(sWrap);
}

/* =========================================================
 PICKER MODAL + RENDERERS (static toolbar, content-only render)
========================================================= */
function openPicker(kind) {
  const modal   = document.getElementById('pickerModal');
  const titleEl = document.getElementById('pickerTitle');
  const content = document.getElementById('pickerContent');

  // prepare content
  content.innerHTML = '';
  if (kind === 'pmg') {
    titleEl.textContent = 'Add Chapter 7 topics';
    document.getElementById('pickerAddCustom').style.display = 'none';
    renderPMGPicker(content);
  } else if (kind === 'skill') {
    titleEl.textContent = 'Short-Term Language Skills';
    document.getElementById('pickerAddCustom').style.display = '';
    renderLanguagePicker(content);
  } else if (kind === 'skillLong') {
    titleEl.textContent = 'Long-Term Language Skills';
    document.getElementById('pickerAddCustom').style.display = '';
    renderLanguagePickerLong(content);
  }

  // wire toolbar (clone-to-clean)
  const expandBtn   = document.getElementById('pickerExpand');
  const collapseBtn = document.getElementById('pickerCollapse');
  const addBtn      = document.getElementById('pickerAddCustom');
  expandBtn.replaceWith(expandBtn.cloneNode(true));
  collapseBtn.replaceWith(collapseBtn.cloneNode(true));
  addBtn.replaceWith(addBtn.cloneNode(true));
  document.getElementById('pickerExpand').addEventListener('click', () => {
    content.querySelectorAll('.section').forEach(sec => sec.classList.remove('collapsed'));
  });
  document.getElementById('pickerCollapse').addEventListener('click', () => {
    content.querySelectorAll('.section').forEach(sec => sec.classList.add('collapsed'));
  });
  document.getElementById('pickerAddCustom').addEventListener('click', () => {
    if (kind === 'skill' || kind === 'skillLong') openCustomGoalModal(kind);
  });

  // open modal + wire close (clone-to-clean)
  modal.setAttribute('aria-hidden', 'false');
  const btnClose = document.getElementById('pickerClose');
  const btnX     = modal.querySelector('.app-modal__close');
  const backdrop = modal.querySelector('.app-modal__backdrop');
  const close = () => {
    modal.setAttribute('aria-hidden', 'true');
    btnClose.replaceWith(btnClose.cloneNode(true));
    btnX.replaceWith(btnX.cloneNode(true));
    backdrop.replaceWith(backdrop.cloneNode(true));
  };
  const wire = () => {
    const cClose    = document.getElementById('pickerClose');
    const cX        = modal.querySelector('.app-modal__close');
    const cBackdrop = modal.querySelector('.app-modal__backdrop');
    cClose.addEventListener('click', close);
    cX.addEventListener('click', close);
    cBackdrop.addEventListener('click', close);
    modal.addEventListener('keydown', (e) => { if (e.key === 'Escape') { e.preventDefault(); close(); } });
  };
  wire();
}
function closePicker() {
  const modal = document.getElementById('pickerModal');
  if (modal && modal.getAttribute('aria-hidden') === 'false') {
    const btnClose = document.getElementById('pickerClose');
    if (btnClose) btnClose.click();
  }
}
function isPickerOpen()    { const m = document.getElementById('pickerModal'); return m && m.getAttribute('aria-hidden') === 'false'; }
function getPickerContent(){ return document.getElementById('pickerContent'); }

function openCustomGoalModal(kind){
  const modal   = document.getElementById('customGoalModal');
  const titleEl = document.getElementById('customGoalTitle');
  const input   = document.getElementById('customGoalInput');
  const errEl   = document.getElementById('customGoalError');
  const btnAdd  = document.getElementById('customGoalAdd');
  const btnCancel = document.getElementById('customGoalCancel');
  const btnX    = modal.querySelector('.app-modal__close');
  const backdrop= modal.querySelector('.app-modal__backdrop');

  const isShort = (kind === 'skill');
  titleEl.textContent = isShort ? 'Custom Short-Term Goal' : 'Custom Long-Term Goal';
  input.value = ''; errEl.style.display = 'none';

  modal.setAttribute('aria-hidden', 'false');
  setTimeout(()=> input.focus(), 0);

  const cleanup = () => {
    modal.setAttribute('aria-hidden', 'true');
    btnAdd.replaceWith(btnAdd.cloneNode(true));
    btnCancel.replaceWith(btnCancel.cloneNode(true));
    btnX.replaceWith(btnX.cloneNode(true));
    backdrop.replaceWith(backdrop.cloneNode(true));
  };
  const valid = (s) => { const t = (s ?? '').trim(); return t.length > 0 && t.length <= 120; };

  const doAddToWeek = (id) => {
    if (isShort) {
      const set = readSet(getFavKeySkill(activeWeek)); if (!set.has(id)) { set.add(id); writeSet(getFavKeySkill(activeWeek), set); }
    } else {
      const set = readSet(getFavKeySkillLong(activeWeek)); if (!set.has(id)) { set.add(id); writeSet(getFavKeySkillLong(activeWeek), set); }
    }
    refreshUI();
  };

  const onSubmit = () => {
    const raw = input.value;
    if (!valid(raw)) { errEl.style.display = 'block'; input.focus(); return; }
    const text = raw.trim();

    // dedupe (Option A)
    const lib = getCustomLib(kind);
    const existing = lib.find(x => (x.title || '').toLowerCase() === text.toLowerCase());

    if (existing) {
      cleanup();
      doAddToWeek(existing.id);
      showToast('Already exists ‚Äî added to plan');
      if (isPickerOpen()) {
        const content = getPickerContent();
        content.innerHTML = '';
        if (isShort) renderLanguagePicker(content); else renderLanguagePickerLong(content);
      }
      return;
    }

    const id = (isShort ? 'cs-' : 'cl-') + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    lib.push({ id, title: text }); setCustomLib(kind, lib);
    cleanup();
    doAddToWeek(id);
    showToast('Added to plan');

    if (isPickerOpen()) {
      const content = getPickerContent();
      content.innerHTML = '';
      if (isShort) renderLanguagePicker(content); else renderLanguagePickerLong(content);
    }
  };

  const wire = () => {
    const addBtn    = document.getElementById('customGoalAdd');
    const cancelBtn = document.getElementById('customGoalCancel');
    const closeBtn  = modal.querySelector('.app-modal__close');
    const back      = modal.querySelector('.app-modal__backdrop');
    addBtn.addEventListener('click', onSubmit);
    cancelBtn.addEventListener('click', cleanup);
    closeBtn.addEventListener('click', cleanup);
    back.addEventListener('click', cleanup);
    modal.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { e.preventDefault(); cleanup(); }
      if (e.key === 'Enter')  { e.preventDefault(); onSubmit(); }
    });
  };
  wire();
}

/* ===== Renderers (CONTENT ONLY; toolbar is static in HTML) ===== */
function renderPMGPicker(container) {
  const ul = document.createElement('ul'); ul.className = 'source-list';
  PMG_TOPICS.forEach(t => ul.appendChild(buildSourceLi({ id: t.id, title: t.title, link: t.link }, 'pmg')));
  container.appendChild(ul);
  refreshPickerAddButtons(container, 'pmg');
  refreshAllCompletionDisplays();
}
function renderLanguagePicker(container) {
  renderCustomGoalsSection(container, 'skill');
  const { sectionNum } = buildNumberingMaps();
  LANGUAGE_SECTIONS.forEach(sec => {
    const sWrap = document.createElement('div'); sWrap.className = 'section collapsed'; sWrap.dataset.sectionId = sec.id;
    const header = document.createElement('div'); header.className = 'section-header';
    header.innerHTML = `<span class="arrow">‚ñ∂</span><span>${sectionNum.get(sec.id)}. ${sec.title}</span>`;
    header.addEventListener('click', () => sWrap.classList.toggle('collapsed'));
    sWrap.appendChild(header);
    const items = document.createElement('ul'); items.className = 'section-items source-list';
    sec.items.forEach((it, index) => {
      const numberedTitle = `${sectionNum.get(sec.id)}.${index+1} ${it.title}`;
      items.appendChild(buildSourceLi({ id: it.id, title: numberedTitle, link: it.link }, 'skill'));
    });
    sWrap.appendChild(items);
    container.appendChild(sWrap);
  });
  refreshPickerAddButtons(container, 'skill');
  refreshAllCompletionDisplays();
}
function renderLanguagePickerLong(container) {
  renderCustomGoalsSection(container, 'skillLong');
  const { sectionNum } = (function(){ const m = new Map(); LANGUAGE_SECTIONS_LONG.forEach((sec, si)=> m.set(sec.id, si+1)); return { sectionNum: m }; })();
  LANGUAGE_SECTIONS_LONG.forEach(sec => {
    const sWrap = document.createElement('div'); sWrap.className = 'section collapsed'; sWrap.dataset.sectionId = sec.id;
    const header = document.createElement('div'); header.className = 'section-header';
    header.innerHTML = `<span class="arrow">‚ñ∂</span><span>${sectionNum.get(sec.id)}. ${sec.title}</span>`;
    header.addEventListener('click', () => sWrap.classList.toggle('collapsed'));
    sWrap.appendChild(header);
    const items = document.createElement('ul'); items.className = 'section-items source-list';
    sec.items.forEach((it, index) => {
      const titled = `${sectionNum.get(sec.id)}.${index+1} ${it.title}`;
      items.appendChild(buildSourceLi({ id: it.id, title: titled, link: it.link }, 'skillLong'));
    });
    sWrap.appendChild(items);
    container.appendChild(sWrap);
  });
  refreshPickerAddButtons(container, 'skillLong');
  refreshAllCompletionDisplays();
}
function refreshPickerAddButtons(container, kind) {
  if (kind === 'pmg') {
    const pmgSet = readSet(getFavKeyPMG(activeWeek));
    const chosen = pmgSet.values().next().value ?? null;
    container.querySelectorAll('li[data-item-id]').forEach(li => {
      const id = li.dataset.itemId; const btn = li.querySelector('.add-btn');
      if (btn) btn.disabled = (id === chosen);
    });
  } else if (kind === 'skill') {
    const skillSet = readSet(getFavKeySkill(activeWeek));
    container.querySelectorAll('li[data-item-id]').forEach(li => {
      const id = li.dataset.itemId; const btn = li.querySelector('.add-btn');
      if (btn) btn.disabled = skillSet.has(id);
    });
  } else if (kind === 'skillLong') {
    const skillSetLT = readSet(getFavKeySkillLong(activeWeek));
    container.querySelectorAll('li[data-item-id]').forEach(li => {
      const id = li.dataset.itemId; const btn = li.querySelector('.add-btn');
      if (btn) btn.disabled = skillSetLT.has(id);
    });
  }
}

/* ===== Add-button click handlers (open the picker) ===== */
document.getElementById('addPMG').addEventListener('click', () => openPicker('pmg'));
document.getElementById('addSkill').addEventListener('click', () => openPicker('skill'));
document.getElementById('addSkillLong').addEventListener('click', () => openPicker('skillLong'));

/* ===== Toggle empty/non-empty state for each box ===== */
function refreshAddOpenButtons() {
  const pmgBox       = document.getElementById('pmgBox');
  const skillBox     = document.getElementById('skillBox');
  const skillBoxLong = document.getElementById('skillBoxLong');
  if (pmgBox)       pmgBox.classList.toggle('empty', document.getElementById('planPMG').children.length       === 0);
  if (skillBox)     skillBox.classList.toggle('empty', document.getElementById('planSkills').children.length    === 0);
  if (skillBoxLong) skillBoxLong.classList.toggle('empty', document.getElementById('planSkillsLong').children.length === 0);
}

/* =========================================================
 INIT / REFRESH
========================================================= */
function refreshUI(){ renderPlan(); refreshAddButtons(); refreshAllCompletionDisplays(); refreshNavButtons(); }
function setActiveWeek(w){ activeWeek=w; localStorage.setItem("activeWeek",String(w)); weekSelect.value=String(w); refreshUI(); }
function init(){
  renderSources();                  // builds hidden sources
  // Force-hide sources section (belt & suspenders)
  const ss = document.getElementById('sourcesSection');
  if (ss) { ss.style.display = 'none'; ss.setAttribute('aria-hidden','true'); }
  refreshUI();
}
init();
</script>

<!-- App Modal (replaces native alert/confirm) -->
<div id="appModal" class="app-modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="app-modal__backdrop"></div>
  <div class="app-modal__dialog" role="document">
    <div class="app-modal__header">
      <div class="app-modal__title">Infield Planner</div>
      <button class="app-modal__close" type="button" aria-label="Close">√ó</button>
    </div>
    <div class="app-modal__body" id="appModalMessage"></div>
    <div class="app-modal__footer">
      <button class="btn" id="appModalCancel" type="button">Cancel</button>
      <button class="btn" id="appModalOk" type="button">OK</button>
    </div>
  </div>
</div>

<!-- Picker Modal -->
<div id="pickerModal" class="app-modal app-modal--picker" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="app-modal__backdrop"></div>
  <div class="app-modal__dialog" role="document">
    <div class="app-modal__header">
      <div class="app-modal__title" id="pickerTitle">Select items</div>
      <button class="app-modal__close" type="button" aria-label="Close">√ó</button>
    </div>
    <div class="app-modal__body">
      <!-- Tight toolbar header (static HTML) -->
      <div id="pickerToolbar">
        <div class="left">
          <button class="btn" id="pickerExpand">Expand all</button>
          <button class="btn" id="pickerCollapse">Collapse all</button>
        </div>
        <div class="right">
          <button class="btn btn-accent" id="pickerAddCustom">+ Add Custom Goal</button>
        </div>
      </div>
      <!-- Dynamic picker content renders here -->
      <div id="pickerContent"></div>
    </div>
    <div class="app-modal__footer">
      <button class="btn" id="pickerClose" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Custom Goal Modal -->
<div id="customGoalModal" class="app-modal app-modal--customgoal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="app-modal__backdrop"></div>
  <div class="app-modal__dialog" role="document">
    <div class="app-modal__header">
      <div class="app-modal__title" id="customGoalTitle">Add Custom Goal</div>
      <button class="app-modal__close" type="button" aria-label="Close">√ó</button>
    </div>
    <div class="app-modal__body">
      <input id="customGoalInput" type="text" placeholder="Describe your goal‚Ä¶" style="width:100%; padding:8px; font-size:1rem;" />
      <div id="customGoalError" style="color:#b91c1c; font-size:.9rem; margin-top:6px; display:none;">
        Please enter a goal (1‚Äì120 characters).
      </div>
    </div>
    <div class="app-modal__footer">
      <button class="btn" id="customGoalCancel" type="button">Cancel</button>
      <button class="btn" id="customGoalAdd" type="button">Add</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>
</body>
</html>